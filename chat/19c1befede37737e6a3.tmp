<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢¨è°­</title>
    <style>
        /* å…¨å±€æ ·å¼ - æç®€é»‘åº•ç™½çº¿ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        body {
            background-color: #000000;
            color: #ffffff;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #333333;
            background: #000000;
            height: 97vh;
            display: flex;
            flex-direction: column;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            padding: 15px;
            border-bottom: 1px solid #333333;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 300;
            letter-spacing: 2px;
            color: #ffffff;
        }
        
        .header .subtitle {
            font-size: 12px;
            color: #888888;
            margin-top: 4px;
        }
        
        .user-info {
            position: absolute;
            right: 15px;
            top: 15px;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
        }
        
        .user-info:hover {
            color: #0099ff;
        }
        
        /* æ¶ˆæ¯åŒºåŸŸæ ·å¼ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #000000;
        }
        
        .message {
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #222222;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .username {
            font-weight: 500;
            color: #ffffff;
            font-size: 13px;
        }
        
        .message-time {
            color: #666666;
            font-size: 11px;
        }
        
        .message-text {
            color: #cccccc;
            line-height: 1.4;
            font-size: 14px;
            word-break: break-word;
            margin-bottom: 5px;
            user-select: text; /* å…è®¸æ–‡æœ¬é€‰æ‹© */
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        .message.own {
            border-left: 2px solid #ffffff;
            padding-left: 10px;
        }
        
        /* å›¾ç‰‡æ¶ˆæ¯æ ·å¼ - æ‡’åŠ è½½ */
        .message-image-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            margin-top: 5px;
        }
        
        .message-image-placeholder {
            width: 200px;
            height: 150px;
            background: #111111;
            border: 1px solid #333333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .message-image-placeholder:hover {
            background: #1a1a1a;
            border-color: #555555;
        }
        
        .placeholder-icon {
            font-size: 24px;
            margin-bottom: 8px;
            color: #666666;
        }
        
        .placeholder-text {
            font-size: 12px;
            color: #888888;
        }
        
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 4px;
            border: 1px solid #333333;
            cursor: pointer;
            transition: opacity 0.2s;
            display: none; /* åˆå§‹éšè—ï¼Œç‚¹å‡»åæ˜¾ç¤º */
        }
        
        .message-image.loaded {
            display: block;
        }
        
        .message-image:hover {
            opacity: 0.9;
        }
        
        /* éŸ³é¢‘æ¶ˆæ¯æ ·å¼ */
        .message-audio {
            margin-top: 5px;
            width: 250px;
        }
        
        .audio-player {
            background: #111111;
            border: 1px solid #333333;
            border-radius: 20px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .audio-play-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .audio-play-btn:hover {
            background: #222222;
        }
        
        .audio-play-btn.playing {
            color: #0099ff;
        }
        
        .audio-progress-container {
            flex: 1;
            height: 4px;
            background: #333333;
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .audio-progress-bar {
            height: 100%;
            background: #0099ff;
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .audio-time {
            font-size: 11px;
            color: #888888;
            min-width: 40px;
        }
        
        .audio-duration {
            font-size: 10px;
            color: #666666;
        }
        
        /* å½•éŸ³ç•Œé¢æ ·å¼ */
        .recording-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .recording-overlay.active {
            display: flex;
        }
        
        .recording-container {
            background: #000000;
            border: 1px solid #333333;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            max-width: 300px;
            width: 90%;
        }
        
        .recording-timer {
            font-size: 32px;
            color: #ffffff;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .recording-visualizer {
            width: 100%;
            height: 80px;
            margin: 20px 0;
            position: relative;
        }
        
        .recording-visualizer canvas {
            width: 100%;
            height: 100%;
        }
        
        .recording-btn {
            background: #ff4444;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            transition: transform 0.2s;
        }
        
        .recording-btn:hover {
            transform: scale(1.05);
        }
        
        .recording-btn.recording {
            animation: pulse 1.5s infinite;
        }
        
        .recording-stop-btn {
            background: #ffffff;
            color: #000000;
            border: none;
            border-radius: 4px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .recording-hint {
            font-size: 12px;
            color: #888888;
            margin-top: 10px;
        }
        
        /* è¾“å…¥åŒºåŸŸæ ·å¼ - åŒæ’å¸ƒå±€ */
        .input-area {
            padding: 10px;
            border-top: 1px solid #333333;
            background: #000000;
        }
        
        .input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .input-row:last-child {
            margin-bottom: 0;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #333333;
            border-radius: 0;
            background: #000000;
            color: #ffffff;
            font-size: 14px;
            outline: none;
        }
        
        .message-input:focus {
            border-color: #666666;
        }
        
        .send-btn {
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            padding: 0 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
            height: 42px;
        }
        
        .send-btn:hover {
            background: #111111;
            border-color: #666666;
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn {
            background: #000000;
            color: #ffffff;
            border: 1px solid #333333;
            padding: 0 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 60px;
        }
        
        .action-btn:hover {
            background: #111111;
            border-color: #666666;
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-btn.recording {
            background: #ff4444;
            border-color: #ff4444;
            color: #ffffff;
        }
        
        .file-input {
            display: none;
        }
        
        .preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 8px;
            padding: 10px;
            border: 1px solid #333333;
            display: none;
        }
        
        .preview-container.active {
            display: flex;
        }
        
        .image-preview {
            position: relative;
            width: 60px;
            height: 60px;
            border: 1px solid #333333;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .remove-preview {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
        }
        
        .image-modal.active {
            display: flex;
        }
        
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .image-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #ffffff;
            font-size: 30px;
            cursor: pointer;
            z-index: 1001;
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #000000;
            color: #ffffff;
            padding: 5px 10px;
            border: 1px solid #333333;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00ff00;
        }
        
        .status-dot.offline {
            background: #ff0000;
        }
        
        .status-dot.error {
            background: #ff9900;
            animation: pulse 1s infinite;
        }
        
        /* é”™è¯¯æç¤º */
        .error-message {
            text-align: center;
            color: #ff4444;
            padding: 10px;
            font-size: 12px;
            border: 1px solid #ff4444;
            margin: 10px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .chat-container::-webkit-scrollbar {
            width: 5px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #000000;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #333333;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666666;
        }
        
        .loading::after {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #333333;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                height: 100vh;
                border: none;
            }
            
            .header {
                padding: 12px;
            }
            
            .user-info {
                position: relative;
                top: 0;
                right: 0;
                margin-top: 8px;
                display: inline-block;
            }
            
            .input-row {
                flex-wrap: wrap;
            }
            
            .action-btn {
                min-width: 50px;
                padding: 0 10px;
            }
            
            .message-image-placeholder {
                width: 150px;
                height: 120px;
            }
            
            .message-audio {
                width: 100%;
                max-width: 250px;
            }
            
            .recording-container {
                padding: 20px;
            }
        }
        
        /* å‹ç¼©æç¤º */
        .compress-notice {
            font-size: 11px;
            color: #888888;
            padding: 5px;
            text-align: center;
            border: 1px solid #333333;
            margin-bottom: 8px;
            display: none;
        }
        
        .compress-notice.active {
            display: block;
        }
        
        /* éŸ³é¢‘åŠ è½½æç¤º */
        .audio-loading {
            font-size: 10px;
            color: #888888;
            margin-left: 5px;
        }
        
        /* æ–°æ¶ˆæ¯æç¤º */
        .new-message-indicator {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #0099ff;
            color: #ffffff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .new-message-indicator.show {
            opacity: 1;
        }
        
        /* å¤åˆ¶æŒ‰é’® */
        .copy-btn {
            position: absolute;
            right: 5px;
            top: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: #ffffff;
            border: 1px solid #333333;
            border-radius: 3px;
            padding: 3px 8px;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        
        .message:hover .copy-btn {
            opacity: 1;
        }
        
        .copy-btn:hover {
            background: rgba(51, 51, 51, 0.7);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¢¨è°­</h1>
            <div class="subtitle">æç®€ Â· ç§å¯†</div>
            <div class="user-info" id="userInfo">
                <span id="username">åŠ è½½ä¸­...</span>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="chat-container" id="chatContainer">
            <div class="loading">æ­£åœ¨è¿æ¥...</div>
        </div>
        
        <!-- æ–°æ¶ˆæ¯æç¤º -->
        <div class="new-message-indicator" id="newMessageIndicator">
            <span>æœ‰æ–°çš„æ¶ˆæ¯</span>
            <span>â†“</span>
        </div>
        
        <!-- å›¾ç‰‡é¢„è§ˆåŒº -->
        <div class="preview-container" id="previewContainer"></div>
        
        <!-- å‹ç¼©æç¤º -->
        <div class="compress-notice" id="compressNotice"></div>
        
        <div class="input-area">
            <!-- ç¬¬ä¸€æ’ï¼šæ–‡å­—è¾“å…¥å’Œå‘é€æŒ‰é’® -->
            <div class="input-row">
                <input type="text" 
                       class="message-input" 
                       id="messageInput" 
                       placeholder="è¾“å…¥æ¶ˆæ¯..."
                       maxlength="500"
                       autocomplete="off">
                <button class="send-btn" id="sendBtn" disabled>å‘é€</button>
            </div>
            
            <!-- ç¬¬äºŒæ’ï¼šå›¾ç‰‡ã€è¯­éŸ³æŒ‰é’® -->
            <div class="input-row">
                <button class="action-btn" id="imageBtn" title="å‘é€å›¾ç‰‡">
                    ğŸ“·
                </button>
                <input type="file" 
                       class="file-input" 
                       id="fileInput" 
                       accept="image/*" 
                       multiple>
                
                <button class="action-btn" id="voiceBtn" title="å‘é€è¯­éŸ³">
                    ğŸ¤
                </button>
            </div>
        </div>
    </div>
    
    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="image-modal" id="imageModal">
        <div class="image-close" id="imageClose">Ã—</div>
        <img id="modalImage" src="" alt="é¢„è§ˆ">
    </div>
    
    <!-- å½•éŸ³ç•Œé¢ -->
    <div class="recording-overlay" id="recordingOverlay">
        <div class="recording-container">
            <div>æŒ‰ä½å½•éŸ³ï¼Œæœ€é•¿15ç§’</div>
            <div class="recording-timer" id="recordingTimer">00:00</div>
            <div class="recording-visualizer">
                <canvas id="recordingCanvas"></canvas>
            </div>
            <button class="recording-btn" id="recordingBtn">
                ğŸ¤
            </button>
            <button class="recording-stop-btn" id="recordingStopBtn" style="display: none;">
                åœæ­¢å¹¶å‘é€
            </button>
            <div class="recording-hint" id="recordingHint">
                æ¾å¼€æ‰‹æŒ‡å‘é€ï¼Œä¸Šæ»‘å–æ¶ˆ
            </div>
        </div>
    </div>
    
    <div class="status-indicator">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">è¿æ¥ä¸­</span>
    </div>
    
    <script>
        // ==================== Giteeé…ç½® ====================
        const GITEE_CONFIG = {
            ACCESS_TOKEN: 'e823c3a1265e30f429305ddebc27f855',
            OWNER: 'yingo-server',
            REPO: 'yingo',
            FILE_PATH: 'message.json',
            IMAGE_DIR: 'chat_images',
            AUDIO_DIR: 'rec',
            API_BASE: 'https://gitee.com/api/v5',
            MAX_RETRIES: 3
        };

        // åº”ç”¨é…ç½®
        const APP_CONFIG = {
            REFRESH_INTERVAL: 3000,
            MAX_MESSAGES: 300,
            SHOW_TIMESTAMP: true,
            // å›¾ç‰‡é…ç½®
            MAX_IMAGE_SIZE: 5 * 1024 * 1024, // 5MB
            COMPRESS_THRESHOLD: 1 * 1024 * 1024, // 1MB ä»¥ä¸Šå‹ç¼©
            MAX_IMAGE_WIDTH: 1920,
            MAX_IMAGE_HEIGHT: 1080,
            IMAGE_QUALITY: 0.7,
            // è¯­éŸ³é…ç½®
            MAX_AUDIO_DURATION: 15, // æœ€å¤§15ç§’
            AUDIO_FORMAT: 'audio/webm',
            AUDIO_BITRATE: 128000,
            // æ‡’åŠ è½½é…ç½®
            LAZY_LOAD_THRESHOLD: 100,
            // æ»šåŠ¨è¡Œä¸ºé…ç½®
            AUTO_SCROLL_THRESHOLD: 100, // è·ç¦»åº•éƒ¨100pxå†…ç®—ä½œåº•éƒ¨
            KEEP_SCROLL_POSITION: true // åˆ·æ–°æ—¶ä¿æŒæ»šåŠ¨ä½ç½®
        };

        // ç”¨æˆ·é…ç½®
        const USER_CONFIG = {
            USERNAME_LIST: [
                'è®¿å®¢ä¸€', 'è®¿å®¢äºŒ', 'è®¿å®¢ä¸‰', 'è®¿å®¢å››', 'è®¿å®¢äº”'
            ],
            DEFAULT_USERNAME: 'åŒ¿åç”¨æˆ·'
        };

        // ==================== æ ¸å¿ƒåŠŸèƒ½ ====================
        class GiteeChat {
            constructor() {
                this.messages = [];
                this.userId = this.getOrCreateUserId();
                this.username = this.getOrCreateUsername();
                this.sha = null;
                this.isLoading = false;
                this.isOnline = true;
                this.retryCount = 0;
                this.lastUpdateTime = 0;
                this.debugMode = true;
                this.imageQueue = [];
                this.uploadingImages = false;
                this.audioQueue = [];
                this.uploadingAudio = false;
                
                // æ‡’åŠ è½½ç›¸å…³
                this.lazyLoadObserver = null;
                this.loadedImages = new Set();
                this.loadedAudios = new Set();
                this.imageLoadQueue = new Map();
                this.audioLoadQueue = new Map();
                
                // çŠ¶æ€ç¼“å­˜
                this.displayedImages = new Set();
                this.displayedImageElements = new Map();
                this.audioElements = new Map();
                
                // æ»šåŠ¨æ§åˆ¶ç›¸å…³
                this.isUserScrolling = false;
                this.lastScrollPosition = 0;
                this.lastScrollHeight = 0;
                this.isAtBottom = true;
                this.scrollTimeout = null;
                this.newMessageCount = 0;
                this.autoScrollEnabled = true;
                this.shouldPreserveScroll = false;
                
                // é€‰æ‹©æ§åˆ¶ç›¸å…³
                this.isUserSelecting = false;
                this.selectionStartTime = 0;
                this.lastSelectionRange = null;
                
                // è¯­éŸ³å½•åˆ¶ç›¸å…³
                this.isRecording = false;
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.recordingStartTime = 0;
                this.recordingTimer = null;
                this.recordingDuration = 0;
                this.audioContext = null;
                this.analyser = null;
                this.visualizerInterval = null;
                this.recordingCanvas = null;
                this.recordingCtx = null;
                
                // éŸ³é¢‘æ’­æ”¾ç›¸å…³
                this.currentAudio = null;
                this.currentAudioElement = null;
                this.audioCache = new Map();
                
                // ä¿®å¤ï¼šæ·»åŠ å›¾ç‰‡åŠ è½½çŠ¶æ€
                this.imageLoading = new Set();
                this.audioLoading = new Set();
                
                this.init();
            }
            
            // åˆå§‹åŒ–
            async init() {
                this.displayUsername();
                this.setupEventListeners();
                this.initLazyLoadObserver();
                await this.loadMessages();
                this.startAutoRefresh();
                this.updateStatus('åœ¨çº¿');
                
                // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬
                this.initScrollTracking();
            }
            
            // åˆå§‹åŒ–æ‡’åŠ è½½è§‚å¯Ÿå™¨
            initLazyLoadObserver() {
                if (this.lazyLoadObserver) {
                    this.lazyLoadObserver.disconnect();
                }
                
                this.lazyLoadObserver = new IntersectionObserver(
                    (entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const element = entry.target;
                                if (element.classList.contains('lazy-image')) {
                                    this.preloadImage(element.dataset.src);
                                }
                            }
                        });
                    },
                    {
                        root: null,
                        rootMargin: `${APP_CONFIG.LAZY_LOAD_THRESHOLD}px`,
                        threshold: 0.01
                    }
                );
            }
            
            // åˆå§‹åŒ–æ»šåŠ¨è·Ÿè¸ª
            initScrollTracking() {
                const chatContainer = document.getElementById('chatContainer');
                
                chatContainer.addEventListener('scroll', () => {
                    this.handleScroll();
                });
                
                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨åº•éƒ¨
                this.checkIfAtBottom();
            }
            
            // å¤„ç†æ»šåŠ¨
            handleScroll() {
                const chatContainer = document.getElementById('chatContainer');
                const scrollTop = chatContainer.scrollTop;
                const scrollHeight = chatContainer.scrollHeight;
                const clientHeight = chatContainer.clientHeight;
                
                // æ ‡è®°ç”¨æˆ·æ­£åœ¨æ»šåŠ¨
                this.isUserScrolling = true;
                
                // æ£€æŸ¥æ˜¯å¦åœ¨åº•éƒ¨
                const distanceToBottom = Math.abs(scrollHeight - scrollTop - clientHeight);
                this.isAtBottom = distanceToBottom <= APP_CONFIG.AUTO_SCROLL_THRESHOLD;
                
                // å¦‚æœç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œéšè—æ–°æ¶ˆæ¯æç¤º
                if (this.isAtBottom) {
                    this.hideNewMessageIndicator();
                    this.newMessageCount = 0;
                }
                
                // æ¸…é™¤ä¹‹å‰çš„æ»šåŠ¨åœæ­¢æ£€æµ‹
                if (this.scrollTimeout) {
                    clearTimeout(this.scrollTimeout);
                }
                
                // æ£€æµ‹æ»šåŠ¨åœæ­¢
                this.scrollTimeout = setTimeout(() => {
                    this.isUserScrolling = false;
                    
                    // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
                    this.lastScrollPosition = scrollTop;
                    this.lastScrollHeight = scrollHeight;
                    
                    // å¦‚æœç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘ï¼Œå¯ç”¨è‡ªåŠ¨æ»šåŠ¨
                    if (this.isAtBottom) {
                        this.autoScrollEnabled = true;
                    }
                }, 150);
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨åº•éƒ¨
            checkIfAtBottom() {
                const chatContainer = document.getElementById('chatContainer');
                const scrollTop = chatContainer.scrollTop;
                const scrollHeight = chatContainer.scrollHeight;
                const clientHeight = chatContainer.clientHeight;
                
                const distanceToBottom = Math.abs(scrollHeight - scrollTop - clientHeight);
                this.isAtBottom = distanceToBottom <= APP_CONFIG.AUTO_SCROLL_THRESHOLD;
                
                return this.isAtBottom;
            }
            
            // æ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤º
            showNewMessageIndicator(count = 1) {
                const indicator = document.getElementById('newMessageIndicator');
                if (count > 1) {
                    indicator.innerHTML = `<span>${count} æ¡æ–°æ¶ˆæ¯</span><span>â†“</span>`;
                } else {
                    indicator.innerHTML = '<span>æœ‰æ–°çš„æ¶ˆæ¯</span><span>â†“</span>';
                }
                indicator.classList.add('show');
            }
            
            // éšè—æ–°æ¶ˆæ¯æç¤º
            hideNewMessageIndicator() {
                const indicator = document.getElementById('newMessageIndicator');
                indicator.classList.remove('show');
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ™ºèƒ½ï¼‰
            scrollToBottom(force = false) {
                if (!force && !this.autoScrollEnabled) {
                    return;
                }
                
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    this.hideNewMessageIndicator();
                    this.newMessageCount = 0;
                }
            }
            
            // æ¢å¤æ»šåŠ¨ä½ç½®
            restoreScrollPosition() {
                const chatContainer = document.getElementById('chatContainer');
                if (!chatContainer || !this.shouldPreserveScroll) return;
                
                // è®¡ç®—æ¯”ä¾‹ä½ç½®
                const oldScrollHeight = this.lastScrollHeight;
                const newScrollHeight = chatContainer.scrollHeight;
                
                if (oldScrollHeight > 0 && newScrollHeight > 0) {
                    // ä¿æŒç›¸å¯¹ä½ç½®
                    const ratio = this.lastScrollPosition / oldScrollHeight;
                    const newPosition = ratio * newScrollHeight;
                    
                    // åº”ç”¨æ–°ä½ç½®
                    chatContainer.scrollTop = newPosition;
                    
                    // å¦‚æœç”¨æˆ·åœ¨åº•éƒ¨é™„è¿‘ï¼Œåˆ™æ»šåŠ¨åˆ°åº•éƒ¨
                    if (this.isAtBottom) {
                        setTimeout(() => {
                            chatContainer.scrollTop = chatContainer.scrollHeight;
                        }, 10);
                    }
                }
                
                this.shouldPreserveScroll = false;
            }
            
            // é¢„åŠ è½½å›¾ç‰‡
            preloadImage(imageUrl) {
                if (this.loadedImages.has(imageUrl) || this.imageLoadQueue.has(imageUrl)) {
                    return;
                }
                
                this.imageLoadQueue.set(imageUrl, true);
                
                const img = new Image();
                img.onload = () => {
                    this.loadedImages.add(imageUrl);
                    this.imageLoadQueue.delete(imageUrl);
                };
                img.onerror = () => {
                    this.imageLoadQueue.delete(imageUrl);
                };
                img.src = imageUrl;
            }
            
            // é¢„åŠ è½½éŸ³é¢‘
            preloadAudio(audioUrl) {
                if (this.loadedAudios.has(audioUrl) || this.audioLoadQueue.has(audioUrl)) {
                    return;
                }
                
                this.audioLoadQueue.set(audioUrl, true);
                
                const audio = new Audio();
                audio.preload = 'metadata';
                audio.onloadedmetadata = () => {
                    this.loadedAudios.add(audioUrl);
                    this.audioCache.set(audioUrl, audio);
                    this.audioLoadQueue.delete(audioUrl);
                };
                audio.onerror = () => {
                    this.audioLoadQueue.delete(audioUrl);
                };
                audio.src = audioUrl;
            }
            
            // è·å–æˆ–åˆ›å»ºç”¨æˆ·ID
            getOrCreateUserId() {
                let userId = localStorage.getItem('chat_userId');
                if (!userId) {
                    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('chat_userId', userId);
                }
                return userId;
            }
            
            // è·å–æˆ–åˆ›å»ºç”¨æˆ·å
            getOrCreateUsername() {
                let username = localStorage.getItem('chat_username');
                if (!username) {
                    const randomIndex = Math.floor(Math.random() * USER_CONFIG.USERNAME_LIST.length);
                    username = USER_CONFIG.USERNAME_LIST[randomIndex];
                    localStorage.setItem('chat_username', username);
                    
                    setTimeout(() => {
                        this.addSystemMessage(`æ¬¢è¿ ${username} åŠ å…¥èŠå¤©å®¤`);
                    }, 1000);
                }
                return username;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·å
            displayUsername() {
                document.getElementById('username').textContent = this.username;
            }
            
            // ä»GiteeåŠ è½½æ¶ˆæ¯
            async loadMessages() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                
                // ä¿å­˜å½“å‰æ»šåŠ¨çŠ¶æ€
                this.saveScrollState();
                
                try {
                    const apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${GITEE_CONFIG.FILE_PATH}?access_token=${GITEE_CONFIG.ACCESS_TOKEN}`;
                    
                    const response = await fetch(apiUrl, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            this.messages = [];
                            this.sha = null;
                            this.renderMessages();
                            this.updateStatus('åœ¨çº¿');
                            this.enableInput();
                            return;
                        } else if (response.status === 403 || response.status === 401) {
                            throw new Error('è®¿é—®ä»¤ç‰Œæ— æ•ˆæˆ–æƒé™ä¸è¶³');
                        } else {
                            throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                        }
                    }
                    
                    const data = await response.json();
                    
                    let content = '';
                    try {
                        if (data.content) {
                            content = this.decodeBase64(data.content);
                        } else {
                            throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                        }
                    } catch (e) {
                        throw new Error('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œæ— æ³•è§£ç ');
                    }
                    
                    this.sha = data.sha;
                    
                    try {
                        const newMessages = JSON.parse(content || '[]');
                        
                        // æ£€æµ‹æ–°æ¶ˆæ¯æ•°é‡
                        if (this.messages.length > 0 && newMessages.length > this.messages.length) {
                            const oldCount = this.messages.length;
                            const newCount = newMessages.length;
                            const addedCount = newCount - oldCount;
                            
                            // å¦‚æœç”¨æˆ·ä¸åœ¨åº•éƒ¨ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤º
                            if (!this.isAtBottom && !this.isUserScrolling) {
                                this.newMessageCount += addedCount;
                                this.showNewMessageIndicator(this.newMessageCount);
                            }
                        }
                        
                        this.messages = newMessages;
                    } catch (e) {
                        console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
                        this.messages = [];
                    }
                    
                    if (this.messages.length > APP_CONFIG.MAX_MESSAGES) {
                        this.messages = this.messages.slice(-APP_CONFIG.MAX_MESSAGES);
                    }
                    
                    // æ™ºèƒ½æ¸²æŸ“æ¶ˆæ¯
                    this.smartRenderMessages();
                    this.retryCount = 0;
                    this.updateStatus('åœ¨çº¿');
                    this.enableInput();
                    this.hideError();
                    
                } catch (error) {
                    console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                    this.retryCount++;
                    
                    if (this.retryCount <= GITEE_CONFIG.MAX_RETRIES) {
                        this.updateStatus(`é‡è¯•ä¸­ (${this.retryCount}/${GITEE_CONFIG.MAX_RETRIES})`);
                        this.showError(`åŠ è½½å¤±è´¥ï¼Œæ­£åœ¨é‡è¯•... (${this.retryCount}/${GITEE_CONFIG.MAX_RETRIES})`);
                        
                        setTimeout(() => this.loadMessages(), 2000 * this.retryCount);
                    } else {
                        this.updateStatus('ç¦»çº¿', 'error');
                        this.showError('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®');
                        this.disableInput();
                    }
                } finally {
                    this.isLoading = false;
                }
            }
            
            // ä¿å­˜æ»šåŠ¨çŠ¶æ€
            saveScrollState() {
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    this.lastScrollPosition = chatContainer.scrollTop;
                    this.lastScrollHeight = chatContainer.scrollHeight;
                    this.shouldPreserveScroll = APP_CONFIG.KEEP_SCROLL_POSITION && !this.isAtBottom;
                }
            }
            
            // æ™ºèƒ½æ¸²æŸ“æ¶ˆæ¯ - ä¿ç•™å·²åŠ è½½çš„å›¾ç‰‡çŠ¶æ€
            smartRenderMessages() {
                const chatContainer = document.getElementById('chatContainer');
                
                // è·å–å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡å…ƒç´ 
                const currentImages = chatContainer.querySelectorAll('.message-image.loaded');
                currentImages.forEach(img => {
                    const src = img.src;
                    if (src) {
                        this.displayedImages.add(src);
                        this.displayedImageElements.set(src, img.cloneNode(true));
                    }
                });
                
                // æ¸²æŸ“æ¶ˆæ¯
                this.renderMessages();
            }
            
            // ä¿å­˜æ¶ˆæ¯åˆ°Gitee
            async saveMessages() {
                try {
                    // ä¿å­˜å‰ç®€åŒ–æ¶ˆæ¯æ•°æ®ï¼Œåªä¿å­˜å¿…è¦çš„å­—æ®µ
                    const simplifiedMessages = this.messages.map(msg => {
                        const simpleMsg = {
                            id: msg.id,
                            userId: msg.userId,
                            username: msg.username,
                            text: msg.text,
                            timestamp: msg.timestamp,
                            time: msg.time
                        };
                        
                        // å¤„ç†å›¾ç‰‡ä¿¡æ¯
                        if (msg.images && msg.images.length > 0) {
                            simpleMsg.images = msg.images.map(img => {
                                if (typeof img === 'string') {
                                    return img; // å·²ç»æ˜¯å­—ç¬¦ä¸²æ ¼å¼
                                } else if (img && img.apiUrl) {
                                    return img.apiUrl; // æå–apiUrl
                                }
                                return img;
                            });
                        }
                        
                        // å¤„ç†éŸ³é¢‘ä¿¡æ¯
                        if (msg.audio) {
                            if (typeof msg.audio === 'string') {
                                simpleMsg.audio = msg.audio;
                            } else if (msg.audio && msg.audio.apiUrl) {
                                simpleMsg.audio = msg.audio.apiUrl;
                            } else {
                                simpleMsg.audio = msg.audio;
                            }
                        }
                        
                        return simpleMsg;
                    });
                    
                    const content = JSON.stringify(simplifiedMessages, null, 2);
                    const encodedContent = this.encodeBase64(content);
                    
                    const apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${GITEE_CONFIG.FILE_PATH}?access_token=${GITEE_CONFIG.ACCESS_TOKEN}`;
                    
                    const body = {
                        content: encodedContent,
                        message: `æ›´æ–°æ¶ˆæ¯ - ${new Date().toISOString()}`,
                        sha: this.sha
                    };
                    
                    const response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        
                        if (response.status === 409) {
                            await this.loadMessages();
                            return await this.saveMessages();
                        }
                        
                        throw new Error(`ä¿å­˜å¤±è´¥: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.sha = data.content.sha;
                    return true;
                    
                } catch (error) {
                    console.error('ä¿å­˜æ¶ˆæ¯å¤±è´¥:', error);
                    return false;
                }
            }
            
            // å‘é€æ¶ˆæ¯
            async sendMessage(text, images = [], audioInfo = null) {
                if (!text.trim() && images.length === 0 && !audioInfo) return false;
                
                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ å›¾ç‰‡
                let imageInfos = [];
                if (images.length > 0) {
                    imageInfos = await this.uploadImages(images);
                    if (imageInfos.length === 0 && !text.trim() && !audioInfo) {
                        this.showError('å›¾ç‰‡ä¸Šä¼ å¤±è´¥');
                        return false;
                    }
                }
                
                const message = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    userId: this.userId,
                    username: this.username,
                    text: text.trim(),
                    images: imageInfos,
                    audio: audioInfo,
                    timestamp: Date.now(),
                    time: this.formatTime(new Date())
                };
                
                // ä¸´æ—¶æ˜¾ç¤ºæ¶ˆæ¯
                this.messages.push(message);
                this.renderMessages();
                
                // å‘é€æ¶ˆæ¯åæ€»æ˜¯æ»šåŠ¨åˆ°åº•éƒ¨
                this.autoScrollEnabled = true;
                this.scrollToBottom(true);
                
                // ä¿å­˜åˆ°Gitee
                const sendBtn = document.getElementById('sendBtn');
                const originalText = sendBtn.textContent;
                sendBtn.textContent = 'å‘é€ä¸­...';
                sendBtn.disabled = true;
                
                const success = await this.saveMessages();
                
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
                
                if (success) {
                    setTimeout(() => this.loadMessages(), 500);
                } else {
                    this.showError('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                return success;
            }
            
            // ä¸Šä¼ å›¾ç‰‡åˆ°Gitee
            async uploadImages(imageFiles) {
                const imageInfos = [];
                this.uploadingImages = true;
                
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    
                    try {
                        if (file.size > APP_CONFIG.MAX_IMAGE_SIZE) {
                            this.showError(`å›¾ç‰‡ ${file.name} è¶…è¿‡${APP_CONFIG.MAX_IMAGE_SIZE / 1024 / 1024}MBé™åˆ¶`);
                            continue;
                        }
                        
                        let processedFile = file;
                        if (file.size > APP_CONFIG.COMPRESS_THRESHOLD) {
                            processedFile = await this.compressImage(file);
                        }
                        
                        const timestamp = Date.now();
                        const randomStr = Math.random().toString(36).substr(2, 6);
                        const fileExt = file.name.split('.').pop() || 'jpg';
                        const fileName = `${timestamp}_${randomStr}.${fileExt}`;
                        const filePath = `${GITEE_CONFIG.IMAGE_DIR}/${fileName}`;
                        
                        const base64Data = await this.fileToBase64(processedFile);
                        const base64Content = base64Data.split(',')[1];
                        
                        const apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${filePath}?access_token=${GITEE_CONFIG.ACCESS_TOKEN}`;
                        
                        const body = {
                            content: base64Content,
                            message: `ä¸Šä¼ å›¾ç‰‡ ${fileName}`,
                            branch: 'master'
                        };
                        
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        });
                        
                        if (!response.ok) {
                            throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        // ä¿®å¤ï¼šä½¿ç”¨ raw é“¾æ¥è€Œä¸æ˜¯ API é“¾æ¥
                        const rawUrl = `https://gitee.com/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/raw/master/${filePath}`;
                        const apiUrlForContent = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${filePath}`;
                        
                        imageInfos.push({
                            rawUrl: rawUrl,
                            apiUrl: apiUrlForContent,
                            path: filePath,
                            fileName: fileName
                        });
                        
                    } catch (error) {
                        console.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`, error);
                        this.showError(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥`);
                    }
                }
                
                this.uploadingImages = false;
                return imageInfos;
            }
            
            // ä¸Šä¼ éŸ³é¢‘åˆ°Gitee
            async uploadAudio(audioBlob) {
                try {
                    if (this.recordingDuration > APP_CONFIG.MAX_AUDIO_DURATION) {
                        this.showError(`è¯­éŸ³è¶…è¿‡${APP_CONFIG.MAX_AUDIO_DURATION}ç§’é™åˆ¶`);
                        return null;
                    }
                    
                    const timestamp = Date.now();
                    const randomStr = Math.random().toString(36).substr(2, 6);
                    const fileName = `${timestamp}_${randomStr}.webm`;
                    const filePath = `${GITEE_CONFIG.AUDIO_DIR}/${fileName}`;
                    
                    const base64Data = await this.blobToBase64(audioBlob);
                    const base64Content = base64Data.split(',')[1];
                    
                    const apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${filePath}?access_token=${GITEE_CONFIG.ACCESS_TOKEN}`;
                    
                    const body = {
                        content: base64Content,
                        message: `ä¸Šä¼ è¯­éŸ³ ${fileName}`,
                        branch: 'master'
                    };
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(body)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    // ä¿®å¤ï¼šä½¿ç”¨ raw é“¾æ¥è€Œä¸æ˜¯ API é“¾æ¥
                    const rawUrl = `https://gitee.com/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/raw/master/${filePath}`;
                    const apiUrlForContent = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${filePath}`;
                    
                    return {
                        rawUrl: rawUrl,
                        apiUrl: apiUrlForContent,
                        path: filePath,
                        fileName: fileName
                    };
                    
                } catch (error) {
                    console.error('éŸ³é¢‘ä¸Šä¼ å¤±è´¥:', error);
                    this.showError(`è¯­éŸ³ä¸Šä¼ å¤±è´¥`);
                    return null;
                }
            }
            
            // å‹ç¼©å›¾ç‰‡
            compressImage(file) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        img.src = e.target.result;
                        
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > APP_CONFIG.MAX_IMAGE_WIDTH) {
                                height = (APP_CONFIG.MAX_IMAGE_WIDTH / width) * height;
                                width = APP_CONFIG.MAX_IMAGE_WIDTH;
                            }
                            
                            if (height > APP_CONFIG.MAX_IMAGE_HEIGHT) {
                                width = (APP_CONFIG.MAX_IMAGE_HEIGHT / height) * width;
                                height = APP_CONFIG.MAX_IMAGE_HEIGHT;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            
                            canvas.toBlob(
                                (blob) => {
                                    if (blob) {
                                        resolve(new File([blob], file.name, {
                                            type: 'image/jpeg',
                                            lastModified: Date.now()
                                        }));
                                    } else {
                                        reject(new Error('å‹ç¼©å¤±è´¥'));
                                    }
                                },
                                'image/jpeg',
                                APP_CONFIG.IMAGE_QUALITY
                            );
                        };
                        
                        img.onerror = () => {
                            reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
                        };
                    };
                    
                    reader.onerror = () => {
                        reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            // å¼€å§‹å½•éŸ³
            async startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            sampleRate: 44100
                        }
                    });
                    
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    const source = this.audioContext.createMediaStreamSource(stream);
                    source.connect(this.analyser);
                    
                    this.analyser.fftSize = 256;
                    this.analyser.smoothingTimeConstant = 0.8;
                    
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: APP_CONFIG.AUDIO_FORMAT,
                        audioBitsPerSecond: APP_CONFIG.AUDIO_BITRATE
                    });
                    
                    this.audioChunks = [];
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = async () => {
                        stream.getTracks().forEach(track => track.stop());
                        
                        if (this.audioChunks.length > 0) {
                            const audioBlob = new Blob(this.audioChunks, { type: APP_CONFIG.AUDIO_FORMAT });
                            
                            document.getElementById('recordingHint').textContent = 'æ­£åœ¨ä¸Šä¼ è¯­éŸ³...';
                            
                            const audioInfo = await this.uploadAudio(audioBlob);
                            
                            document.getElementById('recordingOverlay').classList.remove('active');
                            document.getElementById('voiceBtn').classList.remove('recording');
                            
                            if (audioInfo) {
                                await this.sendMessage('', [], audioInfo);
                            }
                        }
                    };
                    
                    this.mediaRecorder.start(100);
                    this.isRecording = true;
                    this.recordingStartTime = Date.now();
                    
                    document.getElementById('recordingBtn').classList.add('recording');
                    document.getElementById('recordingBtn').style.animation = 'pulse-red 1.5s infinite';
                    document.getElementById('recordingStopBtn').style.display = 'block';
                    
                    this.startRecordingTimer();
                    this.startVisualizer();
                    
                } catch (error) {
                    console.error('å¼€å§‹å½•éŸ³å¤±è´¥:', error);
                    this.showError('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                    this.stopRecording();
                }
            }
            
            // åœæ­¢å½•éŸ³
            stopRecording() {
                if (!this.isRecording || !this.mediaRecorder) return;
                
                if (this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                }
                
                this.stopRecordingTimer();
                this.stopVisualizer();
                
                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }
                
                this.isRecording = false;
                this.recordingDuration = Math.min(
                    (Date.now() - this.recordingStartTime) / 1000,
                    APP_CONFIG.MAX_AUDIO_DURATION
                );
            }
            
            // å¼€å§‹å½•éŸ³è®¡æ—¶å™¨
            startRecordingTimer() {
                const timerElement = document.getElementById('recordingTimer');
                this.recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - this.recordingStartTime) / 1000);
                    const remaining = APP_CONFIG.MAX_AUDIO_DURATION - elapsed;
                    
                    if (remaining <= 0) {
                        this.stopRecording();
                        return;
                    }
                    
                    const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const seconds = (elapsed % 60).toString().padStart(2, '0');
                    timerElement.textContent = `${minutes}:${seconds}`;
                    
                    document.getElementById('recordingHint').textContent = 
                        `å‰©ä½™ ${remaining} ç§’ï¼Œæ¾å¼€å‘é€`;
                        
                }, 100);
            }
            
            // åœæ­¢å½•éŸ³è®¡æ—¶å™¨
            stopRecordingTimer() {
                if (this.recordingTimer) {
                    clearInterval(this.recordingTimer);
                    this.recordingTimer = null;
                }
            }
            
            // å¼€å§‹éŸ³é¢‘å¯è§†åŒ–
            startVisualizer() {
                const canvas = document.getElementById('recordingCanvas');
                const ctx = canvas.getContext('2d');
                this.recordingCanvas = canvas;
                this.recordingCtx = ctx;
                
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
                
                const bufferLength = this.analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                const draw = () => {
                    if (!this.isRecording || !this.analyser) return;
                    
                    requestAnimationFrame(draw);
                    
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const barWidth = (canvas.width / bufferLength) * 2.5;
                    let barHeight;
                    let x = 0;
                    
                    for (let i = 0; i < bufferLength; i++) {
                        barHeight = (dataArray[i] / 255) * canvas.height;
                        
                        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                        gradient.addColorStop(0, '#ff4444');
                        gradient.addColorStop(1, '#ff8888');
                        
                        ctx.fillStyle = gradient;
                        
                        ctx.fillRect(
                            x,
                            canvas.height - barHeight,
                            barWidth,
                            barHeight
                        );
                        
                        x += barWidth + 1;
                    }
                };
                
                this.visualizerInterval = setInterval(draw, 1000 / 30);
            }
            
            // åœæ­¢éŸ³é¢‘å¯è§†åŒ–
            stopVisualizer() {
                if (this.visualizerInterval) {
                    clearInterval(this.visualizerInterval);
                    this.visualizerInterval = null;
                }
                
                if (this.recordingCtx && this.recordingCanvas) {
                    this.recordingCtx.clearRect(0, 0, this.recordingCanvas.width, this.recordingCanvas.height);
                }
            }
            
            // é€šè¿‡APIè·å–æ–‡ä»¶å†…å®¹
            async fetchFileContent(fileInfo) {
                try {
                    let apiUrl;
                    
                    // å¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
                    if (typeof fileInfo === 'string') {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯rawé“¾æ¥ï¼Œå¦‚æœæ˜¯åˆ™è½¬æ¢ä¸ºAPIé“¾æ¥
                        if (fileInfo.includes('/raw/')) {
                            const path = fileInfo.split('/raw/master/')[1];
                            apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${path}`;
                        } else if (fileInfo.includes('/api/v5/')) {
                            apiUrl = fileInfo;
                        } else {
                            // å‡è®¾æ˜¯è·¯å¾„
                            apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${fileInfo}`;
                        }
                    } else if (fileInfo && fileInfo.apiUrl) {
                        apiUrl = fileInfo.apiUrl;
                    } else if (fileInfo && fileInfo.path) {
                        apiUrl = `${GITEE_CONFIG.API_BASE}/repos/${GITEE_CONFIG.OWNER}/${GITEE_CONFIG.REPO}/contents/${fileInfo.path}`;
                    } else {
                        throw new Error('æ— æ•ˆçš„æ–‡ä»¶ä¿¡æ¯');
                    }
                    
                    // æ·»åŠ access_token
                    const urlWithToken = apiUrl + (apiUrl.includes('?') ? '&' : '?') + 
                                       `access_token=${GITEE_CONFIG.ACCESS_TOKEN}`;
                    
                    const response = await fetch(urlWithToken, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`è·å–æ–‡ä»¶å¤±è´¥: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.content) {
                        throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
                    }
                    
                    // æ¸…ç†base64å†…å®¹ï¼Œç§»é™¤æ¢è¡Œç¬¦
                    const cleanContent = data.content.replace(/\n/g, '').replace(/\r/g, '');
                    
                    return {
                        content: cleanContent,
                        encoding: data.encoding || 'base64'
                    };
                    
                } catch (error) {
                    console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
                    throw error;
                }
            }
            
            // è·å–å›¾ç‰‡æ•°æ®
            async getImageData(imageInfo) {
                try {
                    // é¦–å…ˆå°è¯•ä½¿ç”¨ rawUrl
                    if (typeof imageInfo === 'string') {
                        if (imageInfo.includes('/raw/')) {
                            return imageInfo; // ç›´æ¥è¿”å› raw URL
                        }
                    } else if (imageInfo && imageInfo.rawUrl) {
                        return imageInfo.rawUrl; // ç›´æ¥è¿”å› raw URL
                    }
                    
                    // å¦‚æœæ²¡æœ‰ rawUrlï¼Œåˆ™é€šè¿‡ API è·å–
                    const fileData = await this.fetchFileContent(imageInfo);
                    if (!fileData.content) {
                        throw new Error('å›¾ç‰‡å†…å®¹ä¸ºç©º');
                    }
                    
                    // æ ¹æ®æ–‡ä»¶æ‰©å±•åç¡®å®š MIME ç±»å‹
                    let mimeType = 'image/jpeg';
                    let path = '';
                    
                    if (typeof imageInfo === 'string') {
                        path = imageInfo;
                    } else if (imageInfo && imageInfo.path) {
                        path = imageInfo.path;
                    }
                    
                    if (path) {
                        const extension = path.split('.').pop().toLowerCase();
                        if (extension === 'png') mimeType = 'image/png';
                        else if (extension === 'gif') mimeType = 'image/gif';
                        else if (extension === 'webp') mimeType = 'image/webp';
                        else if (extension === 'bmp') mimeType = 'image/bmp';
                        else if (extension === 'svg') mimeType = 'image/svg+xml';
                    }
                    
                    return `data:${mimeType};base64,${fileData.content}`;
                } catch (error) {
                    console.error('è·å–å›¾ç‰‡æ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            
            // è·å–éŸ³é¢‘æ•°æ®
            async getAudioData(audioInfo) {
                try {
                    // é¦–å…ˆå°è¯•ä½¿ç”¨ rawUrl
                    if (typeof audioInfo === 'string') {
                        if (audioInfo.includes('/raw/')) {
                            return audioInfo; // ç›´æ¥è¿”å› raw URL
                        }
                    } else if (audioInfo && audioInfo.rawUrl) {
                        return audioInfo.rawUrl; // ç›´æ¥è¿”å› raw URL
                    }
                    
                    // å¦‚æœæ²¡æœ‰ rawUrlï¼Œåˆ™é€šè¿‡ API è·å–
                    const fileData = await this.fetchFileContent(audioInfo);
                    if (!fileData.content) {
                        throw new Error('éŸ³é¢‘å†…å®¹ä¸ºç©º');
                    }
                    
                    return `data:audio/webm;base64,${fileData.content}`;
                } catch (error) {
                    console.error('è·å–éŸ³é¢‘æ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            
            // åŠ è½½å›¾ç‰‡
            async loadImage(imageInfo, placeholder, imageElement) {
                // ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
                const imageKey = typeof imageInfo === 'string' ? imageInfo : JSON.stringify(imageInfo);
                
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½
                if (this.imageLoading.has(imageKey)) {
                    return;
                }
                
                this.imageLoading.add(imageKey);
                placeholder.querySelector('.placeholder-text').textContent = 'åŠ è½½ä¸­...';
                
                try {
                    const imageUrl = await this.getImageData(imageInfo);
                    if (imageUrl) {
                        const img = new Image();
                        
                        img.onload = () => {
                            placeholder.style.display = 'none';
                            imageElement.src = imageUrl;
                            imageElement.classList.add('loaded');
                            imageElement.style.display = 'block';
                            
                            this.loadedImages.add(imageKey);
                            this.displayedImages.add(imageKey);
                            this.imageLoading.delete(imageKey);
                        };
                        
                        img.onerror = () => {
                            placeholder.querySelector('.placeholder-text').textContent = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                            placeholder.style.cursor = 'pointer';
                            this.imageLoading.delete(imageKey);
                            
                            // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                            placeholder.onclick = () => {
                                this.loadImage(imageInfo, placeholder, imageElement);
                            };
                        };
                        
                        img.src = imageUrl;
                    } else {
                        throw new Error('è·å–å›¾ç‰‡URLå¤±è´¥');
                    }
                } catch (error) {
                    console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                    placeholder.querySelector('.placeholder-text').textContent = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                    placeholder.style.cursor = 'pointer';
                    this.imageLoading.delete(imageKey);
                    
                    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                    placeholder.onclick = () => {
                        this.loadImage(imageInfo, placeholder, imageElement);
                    };
                }
            }
            
            // æ’­æ”¾éŸ³é¢‘
            async playAudio(audioInfo, playBtn, progressBar, timeDisplay) {
                const audioKey = typeof audioInfo === 'string' ? audioInfo : JSON.stringify(audioInfo);
                
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨æ’­æ”¾åŒä¸€éŸ³é¢‘
                if (this.currentAudio && this.currentAudio === audioKey && this.currentAudioElement) {
                    // æš‚åœæ’­æ”¾
                    if (!this.currentAudioElement.paused) {
                        this.currentAudioElement.pause();
                        this.currentAudioElement.currentTime = 0;
                        playBtn.classList.remove('playing');
                        playBtn.textContent = 'â–¶';
                        progressBar.style.width = '0%';
                        timeDisplay.textContent = '00:00';
                        this.currentAudio = null;
                        this.currentAudioElement = null;
                    } else {
                        // é‡æ–°å¼€å§‹æ’­æ”¾
                        this.currentAudioElement.play();
                        playBtn.classList.add('playing');
                        playBtn.textContent = 'â¸';
                    }
                    return;
                }
                
                // åœæ­¢å…¶ä»–éŸ³é¢‘
                if (this.currentAudio && this.currentAudioElement) {
                    this.currentAudioElement.pause();
                    this.currentAudioElement.currentTime = 0;
                    const currentPlayBtn = document.querySelector('.audio-play-btn.playing');
                    if (currentPlayBtn) {
                        currentPlayBtn.classList.remove('playing');
                        currentPlayBtn.textContent = 'â–¶';
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æ­£åœ¨åŠ è½½
                if (this.audioLoading.has(audioKey)) {
                    return;
                }
                
                this.audioLoading.add(audioKey);
                playBtn.textContent = 'â³';
                playBtn.disabled = true;
                
                try {
                    const audioUrl = await this.getAudioData(audioInfo);
                    if (!audioUrl) {
                        throw new Error('è·å–éŸ³é¢‘URLå¤±è´¥');
                    }
                    
                    let audio;
                    
                    // æ£€æŸ¥ç¼“å­˜
                    if (this.audioCache.has(audioKey)) {
                        audio = this.audioCache.get(audioKey);
                    } else {
                        audio = new Audio(audioUrl);
                        this.audioCache.set(audioKey, audio);
                    }
                    
                    // è®¾ç½®éŸ³é¢‘äº‹ä»¶
                    audio.oncanplaythrough = () => {
                        playBtn.textContent = 'â–¶';
                        playBtn.disabled = false;
                        this.audioLoading.delete(audioKey);
                    };
                    
                    audio.onerror = () => {
                        playBtn.textContent = 'â–¶';
                        playBtn.disabled = false;
                        this.audioLoading.delete(audioKey);
                        this.showError('éŸ³é¢‘åŠ è½½å¤±è´¥');
                    };
                    
                    audio.ontimeupdate = () => {
                        if (audio.duration && !isNaN(audio.duration)) {
                            const progress = (audio.currentTime / audio.duration) * 100;
                            progressBar.style.width = `${progress}%`;
                            
                            const currentTime = Math.floor(audio.currentTime);
                            const minutes = Math.floor(currentTime / 60).toString().padStart(2, '0');
                            const seconds = (currentTime % 60).toString().padStart(2, '0');
                            timeDisplay.textContent = `${minutes}:${seconds}`;
                        }
                    };
                    
                    audio.onended = () => {
                        playBtn.classList.remove('playing');
                        playBtn.textContent = 'â–¶';
                        progressBar.style.width = '0%';
                        timeDisplay.textContent = '00:00';
                        this.currentAudio = null;
                        this.currentAudioElement = null;
                    };
                    
                    audio.onpause = () => {
                        if (audio.currentTime >= audio.duration || audio.currentTime === 0) {
                            playBtn.classList.remove('playing');
                            playBtn.textContent = 'â–¶';
                            progressBar.style.width = '0%';
                            timeDisplay.textContent = '00:00';
                        }
                    };
                    
                    // å¼€å§‹æ’­æ”¾
                    this.currentAudio = audioKey;
                    this.currentAudioElement = audio;
                    
                    await audio.play();
                    
                    playBtn.classList.add('playing');
                    playBtn.textContent = 'â¸';
                    
                } catch (error) {
                    console.error('æ’­æ”¾éŸ³é¢‘å¤±è´¥:', error);
                    playBtn.textContent = 'â–¶';
                    playBtn.disabled = false;
                    this.audioLoading.delete(audioKey);
                    this.showError('éŸ³é¢‘æ’­æ”¾å¤±è´¥');
                }
            }
            
            // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
            copyTextToClipboard(text) {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showTemporaryMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(err => {
                        this.copyTextFallback(text);
                    });
                } else {
                    this.copyTextFallback(text);
                }
            }
            
            // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
            copyTextFallback(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    this.showTemporaryMessage('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    this.showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
                }
                
                document.body.removeChild(textArea);
            }
            
            // æ˜¾ç¤ºä¸´æ—¶æ¶ˆæ¯
            showTemporaryMessage(message) {
                const tempMsg = document.createElement('div');
                tempMsg.textContent = message;
                tempMsg.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 10px 20px;
                    border-radius: 5px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                document.body.appendChild(tempMsg);
                
                setTimeout(() => {
                    document.body.removeChild(tempMsg);
                }, 1500);
            }
            
            // æ–‡ä»¶è½¬Base64
            fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // Blobè½¬Base64
            blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
            
            // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
            addSystemMessage(text) {
                const message = {
                    id: 'system_' + Date.now(),
                    type: 'system',
                    text: text,
                    timestamp: Date.now(),
                    time: this.formatTime(new Date())
                };
                
                const chatContainer = document.getElementById('chatContainer');
                const systemMsg = document.createElement('div');
                systemMsg.className = 'system-message';
                systemMsg.textContent = text;
                chatContainer.appendChild(systemMsg);
                this.scrollToBottom();
            }
            
            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages() {
                const chatContainer = document.getElementById('chatContainer');
                
                // æ¸…é™¤æ—§çš„åŠ è½½æç¤º
                const loadingElements = chatContainer.querySelectorAll('.loading, .system-message:first-child');
                loadingElements.forEach(el => {
                    if (el.textContent.includes('æ­£åœ¨è¿æ¥') || el.textContent.includes('æš‚æ— æ¶ˆæ¯')) {
                        el.remove();
                    }
                });
                
                // ä¿å­˜å½“å‰é€‰ä¸­çš„æ–‡æœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
                this.saveTextSelection();
                
                chatContainer.innerHTML = '';
                
                if (this.messages.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.className = 'system-message';
                    emptyMsg.textContent = 'è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œå¿«æ¥è¯´ç‚¹ä»€ä¹ˆå§~';
                    chatContainer.appendChild(emptyMsg);
                    return;
                }
                
                this.messages.forEach(msg => {
                    if (msg.type === 'system') {
                        const systemMsg = document.createElement('div');
                        systemMsg.className = 'system-message';
                        systemMsg.textContent = msg.text;
                        chatContainer.appendChild(systemMsg);
                    } else {
                        const isOwn = msg.userId === this.userId;
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${isOwn ? 'own' : ''}`;
                        
                        let contentHTML = '';
                        
                        // æ–‡æœ¬å†…å®¹
                        if (msg.text) {
                            const messageId = `msg_${msg.id}`;
                            contentHTML += `
                                <div class="message-text" id="${messageId}">${this.escapeHtml(msg.text)}</div>
                                <button class="copy-btn" data-message-id="${messageId}">å¤åˆ¶</button>
                            `;
                        }
                        
                        // å›¾ç‰‡å†…å®¹
                        if (msg.images && msg.images.length > 0) {
                            msg.images.forEach((imgInfo, index) => {
                                const imageId = `image_${msg.id}_${index}`;
                                
                                contentHTML += `
                                    <div class="message-image-container">
                                        <div class="message-image-placeholder" 
                                             id="placeholder_${imageId}"
                                             data-image-info='${JSON.stringify(imgInfo)}'>
                                            <div class="placeholder-icon">ğŸ–¼ï¸</div>
                                            <div class="placeholder-text">ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡</div>
                                        </div>
                                        <img class="message-image" 
                                             id="${imageId}"
                                             data-image-info='${JSON.stringify(imgInfo)}'
                                             alt="å›¾ç‰‡"
                                             style="display: none;">
                                    </div>
                                `;
                            });
                        }
                        
                        // è¯­éŸ³å†…å®¹
                        if (msg.audio) {
                            const audioId = `audio_${msg.id}`;
                            const playBtnId = `play_${msg.id}`;
                            const progressBarId = `progress_${msg.id}`;
                            const timeDisplayId = `time_${msg.id}`;
                            
                            contentHTML += `
                                <div class="message-audio">
                                    <div class="audio-player">
                                        <button class="audio-play-btn" id="${playBtnId}" data-audio-info='${JSON.stringify(msg.audio)}'>
                                            â–¶
                                        </button>
                                        <div class="audio-progress-container">
                                            <div class="audio-progress-bar" id="${progressBarId}"></div>
                                        </div>
                                        <div class="audio-time" id="${timeDisplayId}">00:00</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        messageElement.innerHTML = `
                            <div class="message-header">
                                <div class="username">${this.escapeHtml(msg.username)}</div>
                                <div class="message-time">${msg.time || this.formatTime(new Date(msg.timestamp))}</div>
                            </div>
                            ${contentHTML}
                        `;
                        
                        chatContainer.appendChild(messageElement);
                        
                        // ä¸ºå¤åˆ¶æŒ‰é’®æ·»åŠ äº‹ä»¶
                        if (msg.text) {
                            const copyBtn = messageElement.querySelector('.copy-btn');
                            if (copyBtn) {
                                const messageText = msg.text;
                                copyBtn.addEventListener('click', (e) => {
                                    e.stopPropagation();
                                    this.copyTextToClipboard(messageText);
                                });
                            }
                        }
                        
                        // ä¸ºå›¾ç‰‡å ä½ç¬¦æ·»åŠ äº‹ä»¶
                        if (msg.images && msg.images.length > 0) {
                            msg.images.forEach((imgInfo, index) => {
                                const imageId = `image_${msg.id}_${index}`;
                                const placeholder = document.getElementById(`placeholder_${imageId}`);
                                const imageElement = document.getElementById(imageId);
                                
                                if (placeholder && imageElement) {
                                    placeholder.addEventListener('click', () => {
                                        this.loadImage(imgInfo, placeholder, imageElement);
                                    });
                                    
                                    if (this.lazyLoadObserver) {
                                        this.lazyLoadObserver.observe(imageElement);
                                    }
                                }
                            });
                        }
                        
                        // ä¸ºéŸ³é¢‘æ¶ˆæ¯æ·»åŠ äº‹ä»¶
                        if (msg.audio) {
                            const playBtn = document.getElementById(`play_${msg.id}`);
                            const progressBar = document.getElementById(`progress_${msg.id}`);
                            const timeDisplay = document.getElementById(`time_${msg.id}`);
                            
                            if (playBtn) {
                                playBtn.addEventListener('click', () => {
                                    this.playAudio(msg.audio, playBtn, progressBar, timeDisplay);
                                });
                            }
                        }
                    }
                });
                
                // æ¢å¤æ–‡æœ¬é€‰æ‹©ï¼ˆå¦‚æœä¹‹å‰æœ‰ï¼‰
                this.restoreTextSelection();
                
                // æ¢å¤æ»šåŠ¨ä½ç½®æˆ–æ»šåŠ¨åˆ°åº•éƒ¨
                if (this.shouldPreserveScroll && !this.isAtBottom) {
                    setTimeout(() => {
                        this.restoreScrollPosition();
                    }, 50);
                } else if (this.autoScrollEnabled && this.isAtBottom) {
                    setTimeout(() => {
                        this.scrollToBottom(true);
                    }, 100);
                }
            }
            
            // ä¿å­˜æ–‡æœ¬é€‰æ‹©
            saveTextSelection() {
                const selection = window.getSelection();
                if (selection && selection.rangeCount > 0 && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const chatContainer = document.getElementById('chatContainer');
                    
                    // æ£€æŸ¥é€‰æ‹©æ˜¯å¦åœ¨èŠå¤©å®¹å™¨å†…
                    if (chatContainer.contains(range.commonAncestorContainer) || 
                        range.commonAncestorContainer === chatContainer) {
                        
                        this.isUserSelecting = true;
                        this.selectionStartTime = Date.now();
                        this.lastSelectionRange = range;
                    }
                }
            }
            
            // æ¢å¤æ–‡æœ¬é€‰æ‹©
            restoreTextSelection() {
                if (this.isUserSelecting && this.lastSelectionRange) {
                    try {
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(this.lastSelectionRange);
                        
                        // é‡ç½®é€‰æ‹©çŠ¶æ€
                        setTimeout(() => {
                            this.isUserSelecting = false;
                            this.lastSelectionRange = null;
                        }, 100);
                    } catch (e) {
                        // é€‰æ‹©æ¢å¤å¤±è´¥ï¼Œå¿½ç•¥
                        this.isUserSelecting = false;
                        this.lastSelectionRange = null;
                    }
                }
            }
            
            // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
            startAutoRefresh() {
                const initialDelay = Math.random() * 3000;
                
                setTimeout(() => {
                    setInterval(() => {
                        // å¦‚æœç”¨æˆ·æ­£åœ¨é€‰æ‹©æ–‡æœ¬ï¼Œå»¶è¿Ÿåˆ·æ–°
                        if (this.isUserSelecting) {
                            const selectionDuration = Date.now() - this.selectionStartTime;
                            if (selectionDuration < 2000) { // é€‰æ‹©å¼€å§‹å2ç§’å†…ä¸åˆ·æ–°
                                return;
                            }
                        }
                        this.loadMessages();
                    }, APP_CONFIG.REFRESH_INTERVAL);
                }, initialDelay);
            }
            
            // æ›´æ–°è¿æ¥çŠ¶æ€
            updateStatus(status, type = 'online') {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusText.textContent = status;
                
                if (type === 'online') {
                    statusDot.className = 'status-dot';
                } else if (type === 'error') {
                    statusDot.className = 'status-dot error';
                } else {
                    statusDot.className = 'status-dot offline';
                }
            }
            
            // å¯ç”¨è¾“å…¥æ¡†
            enableInput() {
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('imageBtn').disabled = false;
                document.getElementById('voiceBtn').disabled = false;
                document.getElementById('messageInput').disabled = false;
                document.getElementById('messageInput').placeholder = 'è¾“å…¥æ¶ˆæ¯...';
            }
            
            // ç¦ç”¨è¾“å…¥æ¡†
            disableInput() {
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('imageBtn').disabled = true;
                document.getElementById('voiceBtn').disabled = true;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('messageInput').placeholder = 'è¿æ¥å·²æ–­å¼€...';
            }
            
            // æ˜¾ç¤ºé”™è¯¯
            showError(message) {
                const errorElement = document.getElementById('errorMessage');
                errorElement.textContent = message;
                errorElement.classList.add('show');
                
                setTimeout(() => {
                    errorElement.classList.remove('show');
                }, 3000);
            }
            
            // éšè—é”™è¯¯
            hideError() {
                const errorElement = document.getElementById('errorMessage');
                errorElement.classList.remove('show');
            }
            
            // Base64ç¼–ç 
            encodeBase64(str) {
                try {
                    return btoa(unescape(encodeURIComponent(str)));
                } catch (error) {
                    return btoa(str);
                }
            }
            
            // Base64è§£ç 
            decodeBase64(str) {
                try {
                    return decodeURIComponent(escape(atob(str)));
                } catch (error) {
                    return atob(str);
                }
            }
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                const sendBtn = document.getElementById('sendBtn');
                const messageInput = document.getElementById('messageInput');
                const userInfo = document.getElementById('userInfo');
                const imageBtn = document.getElementById('imageBtn');
                const voiceBtn = document.getElementById('voiceBtn');
                const fileInput = document.getElementById('fileInput');
                const previewContainer = document.getElementById('previewContainer');
                const compressNotice = document.getElementById('compressNotice');
                const recordingBtn = document.getElementById('recordingBtn');
                const recordingStopBtn = document.getElementById('recordingStopBtn');
                const recordingOverlay = document.getElementById('recordingOverlay');
                const newMessageIndicator = document.getElementById('newMessageIndicator');
                
                let selectedImages = [];
                
                // æ–°æ¶ˆæ¯æç¤ºç‚¹å‡»äº‹ä»¶
                newMessageIndicator.addEventListener('click', () => {
                    this.scrollToBottom(true);
                });
                
                // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                sendBtn.addEventListener('click', async () => {
                    const text = messageInput.value.trim();
                    
                    if (text || selectedImages.length > 0) {
                        const success = await this.sendMessage(text, selectedImages);
                        if (success) {
                            messageInput.value = '';
                            selectedImages = [];
                            previewContainer.innerHTML = '';
                            previewContainer.classList.remove('active');
                            compressNotice.classList.remove('active');
                        }
                        messageInput.focus();
                    }
                });
                
                // è¾“å…¥æ¡†å›è½¦äº‹ä»¶
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendBtn.click();
                    }
                });
                
                // å›¾ç‰‡æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                imageBtn.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // è¯­éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                voiceBtn.addEventListener('click', () => {
                    recordingOverlay.classList.add('active');
                    voiceBtn.classList.add('recording');
                });
                
                // å¼€å§‹å½•éŸ³æŒ‰é’®
                recordingBtn.addEventListener('mousedown', () => {
                    this.startRecording();
                });
                
                recordingBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startRecording();
                });
                
                // åœæ­¢å½•éŸ³æŒ‰é’®
                recordingStopBtn.addEventListener('click', () => {
                    this.stopRecording();
                });
                
                // å½•éŸ³ç•Œé¢ç‚¹å‡»å¤–éƒ¨å…³é—­
                recordingOverlay.addEventListener('click', (e) => {
                    if (e.target === recordingOverlay) {
                        this.stopRecording();
                        recordingOverlay.classList.remove('active');
                        voiceBtn.classList.remove('recording');
                    }
                });
                
                // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    
                    if (files.length === 0) return;
                    
                    if (files.length > 5) {
                        this.showError('æœ€å¤šåªèƒ½é€‰æ‹©5å¼ å›¾ç‰‡');
                        return;
                    }
                    
                    let hasLargeFile = false;
                    files.forEach(file => {
                        if (file.size > APP_CONFIG.MAX_IMAGE_SIZE) {
                            this.showError(`${file.name} è¶…è¿‡${APP_CONFIG.MAX_IMAGE_SIZE / 1024 / 1024}MBé™åˆ¶`);
                            hasLargeFile = true;
                        }
                    });
                    
                    if (hasLargeFile) return;
                    
                    selectedImages = [];
                    previewContainer.innerHTML = '';
                    
                    files.forEach((file, index) => {
                        selectedImages.push(file);
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewDiv = document.createElement('div');
                            previewDiv.className = 'image-preview';
                            previewDiv.innerHTML = `
                                <img src="${e.target.result}" alt="é¢„è§ˆ">
                                <button class="remove-preview" data-index="${index}">Ã—</button>
                            `;
                            previewContainer.appendChild(previewDiv);
                            
                            previewDiv.querySelector('.remove-preview').addEventListener('click', (e) => {
                                e.stopPropagation();
                                const idx = parseInt(e.target.dataset.index);
                                selectedImages.splice(idx, 1);
                                previewDiv.remove();
                                
                                const removeBtns = previewContainer.querySelectorAll('.remove-preview');
                                removeBtns.forEach((btn, i) => {
                                    btn.dataset.index = i;
                                });
                                
                                if (selectedImages.length === 0) {
                                    previewContainer.classList.remove('active');
                                    compressNotice.classList.remove('active');
                                }
                            });
                            
                            previewContainer.classList.add('active');
                            
                            if (file.size > APP_CONFIG.COMPRESS_THRESHOLD) {
                                compressNotice.textContent = 'æ£€æµ‹åˆ°å¤§å›¾ï¼Œå°†è‡ªåŠ¨å‹ç¼©...';
                                compressNotice.classList.add('active');
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                    
                    fileInput.value = '';
                });
                
                // åŒå‡»ç”¨æˆ·åå¯ä»¥æ›´æ”¹
                userInfo.addEventListener('dblclick', () => {
                    const newName = prompt('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·åï¼ˆä¸è¶…è¿‡10ä¸ªå­—ç¬¦ï¼‰:', this.username);
                    if (newName && newName.trim() && newName.trim().length <= 10) {
                        const oldName = this.username;
                        this.username = newName.trim();
                        localStorage.setItem('chat_username', this.username);
                        this.displayUsername();
                        this.addSystemMessage(`${oldName} æ›´åä¸º ${this.username}`);
                    }
                });
                
                // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        this.loadMessages();
                    }
                });
                
                // ç½‘ç»œçŠ¶æ€å˜åŒ–
                window.addEventListener('online', () => {
                    this.updateStatus('é‡æ–°è¿æ¥ä¸­...');
                    this.loadMessages();
                });
                
                window.addEventListener('offline', () => {
                    this.updateStatus('ç¦»çº¿', 'error');
                    this.showError('ç½‘ç»œè¿æ¥å·²æ–­å¼€');
                });
            }
            
            // æ ¼å¼åŒ–æ—¶é—´
            formatTime(date) {
                return date.toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            // HTMLè½¬ä¹‰
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // è°ƒè¯•æ—¥å¿—
            logDebug(...args) {
                if (this.debugMode) {
                    console.log('[DEBUG]', ...args);
                }
            }
            
            // é”™è¯¯æ—¥å¿—
            logError(...args) {
                console.error('[ERROR]', ...args);
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            try {
                window.chatApp = new GiteeChat();
            } catch (error) {
                console.error('èŠå¤©å®¤å¯åŠ¨å¤±è´¥:', error);
                document.getElementById('errorMessage').textContent = 'èŠå¤©å®¤å¯åŠ¨å¤±è´¥: ' + error.message;
                document.getElementById('errorMessage').classList.add('show');
                document.getElementById('statusDot').className = 'status-dot error';
                document.getElementById('statusText').textContent = 'å¯åŠ¨å¤±è´¥';
            }
        });
    </script>
</body>
</html>