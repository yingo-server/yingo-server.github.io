// ==================== 工具函数 ====================
if (typeof giteeRequest === 'undefined') {
    window.giteeRequest = async function(url, options = {}) {
        var separator = url.indexOf('?') === -1 ? '?' : '&';
        var fullUrl = url + separator + 'access_token=' + GITEE_CONFIG.ACCESS_TOKEN;
        var response = await fetch(fullUrl, {
            method: options.method || 'GET',
            headers: { 'Content-Type': 'application/json' },
            body: options.body
        });
        var text = await response.text();
        var data;
        try { data = JSON.parse(text); } catch (e) { data = text; }
        if (!response.ok) {
            var err = new Error(data.message || 'HTTP ' + response.status);
            err.status = response.status; err.data = data; throw err;
        }
        return data;
    };
}
if (typeof b64ToUtf8 === 'undefined') {
    window.b64ToUtf8 = function(str) {
        if (!str) return '';
        var clean = str.replace(/\s/g, '');
        return decodeURIComponent(escape(window.atob(clean)));
    };
}
if (typeof utf8ToB64 === 'undefined') {
    window.utf8ToB64 = function(str) {
        return window.btoa(unescape(encodeURIComponent(str)));
    };
}

// ==================== 读取用户文件（原有）====================
async function readUserFile(username, fileName) {
    var filePath = 'user_data/' + username + '/' + fileName;
    var encodedPath = filePath.split('/').map(seg => encodeURIComponent(seg)).join('/');
    var url = GITEE_CONFIG.BASE_URL + '/repos/' + GITEE_CONFIG.OWNER + '/' + GITEE_CONFIG.REPO + '/contents/' + encodedPath;
    try {
        var data = await giteeRequest(url, { method: 'GET' });
        if (Array.isArray(data) && data.length === 0) return '';
        if (data && data.content) return b64ToUtf8(data.content);
        return '';
    } catch (e) {
        if (e.status === 404) return '';
        throw e;
    }
}

// ==================== 原有函数：加载文章列表 ====================
async function loadPostList(username) {
    var listDiv = document.getElementById('post-list');
    if (!listDiv) return;
    listDiv.innerHTML = '加载中...';
    
    try {
        var url = GITEE_CONFIG.BASE_URL + '/repos/' + GITEE_CONFIG.OWNER + '/' + GITEE_CONFIG.REPO + '/contents/post_data';
        var items = await giteeRequest(url);
        var postFiles = items.filter(item => item.type === 'file' && item.name.endsWith('.json') && item.name.includes('-' + username + '.json'));
        
        var posts = [];
        for (var file of postFiles) {
            var fileUrl = GITEE_CONFIG.BASE_URL + '/repos/' + GITEE_CONFIG.OWNER + '/' + GITEE_CONFIG.REPO + '/contents/' + encodeURIComponent(file.path);
            var fileData = await giteeRequest(fileUrl);
            var content = b64ToUtf8(fileData.content);
            var post = JSON.parse(content);
            posts.push({
                title: post.title,
                time: post.time
            });
        }
        
        posts.sort((a, b) => new Date(b.time) - new Date(a.time));
        
        if (posts.length === 0) {
            listDiv.innerHTML = '<p style="color: #757575;">暂无文章</p>';
        } else {
            var html = '';
            posts.forEach(p => {
                var date = new Date(p.time).toLocaleString();
                html += `<div style="margin-bottom: 8px;">
                    <div style="font-weight: 500;">${p.title}</div>
                    <div style="font-size: 12px; color: #757575;">${date}</div>
                </div>`;
            });
            listDiv.innerHTML = html;
        }
    } catch (e) {
        console.error('加载文章列表失败', e);
        listDiv.innerHTML = '<p style="color: #f44336;">加载失败</p>';
    }
}

// ==================== 原有函数：加载用户信息 ====================
async function loadUserInfo() {
    var username = currentUser.username;
    document.getElementById('profile-username').textContent = username;
    
    try {
        var postData = await readUserFile(username, 'post.txt');
        var postLines = postData.split('\n');
        var postCount = parseInt(postLines[0]) || 0;
        document.getElementById('post-count').textContent = postCount;
    } catch (e) {
        document.getElementById('post-count').textContent = '0';
    }
    
    try {
        var comeData = await readUserFile(username, 'come.txt');
        var comeLines = comeData.split('\n');
        var registerTime = comeLines[0] ? new Date(comeLines[0]).toLocaleString() : '-';
        var lastLoginTime = comeLines[1] ? new Date(comeLines[1]).toLocaleString() : '-';
        document.getElementById('register-time').textContent = registerTime;
        document.getElementById('last-login-time').textContent = lastLoginTime;
    } catch (e) {}
    
    try {
        var activeData = await readUserFile(username, 'active.txt');
        var lines = activeData.split('\n').filter(line => line.trim() !== '');
        document.getElementById('follow-count').textContent = lines.length;
    } catch (e) {
        document.getElementById('follow-count').textContent = '0';
    }
    
    await loadPostList(username);
}

// ==================== 原有折叠函数 ====================
function toggleCollapse(contentId, iconId) {
    var content = document.getElementById(contentId);
    var icon = document.getElementById(iconId);
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '▼';
    } else {
        content.style.display = 'none';
        icon.textContent = '▶';
    }
}

function togglePostList() {
    var listDiv = document.getElementById('post-list');
    var icon = document.getElementById('post-expand-icon');
    if (listDiv.style.display === 'none') {
        listDiv.style.display = 'block';
        icon.textContent = '▼';
    } else {
        listDiv.style.display = 'none';
        icon.textContent = '▶';
    }
}

// ==================== 新增：主题设置相关函数 ====================
async function readUserSettings(username) {
    var content = await readUserFile(username, 'set.txt');
    var lines = content.split('\n');
    var settings = {};
    lines.forEach(line => {
        line = line.trim();
        if (line && line.includes('=')) {
            var parts = line.split('=');
            var key = parts[0].trim();
            var value = parts[1].trim();
            settings[key] = value;
        }
    });
    console.log('读取设置:', settings); // 调试
    return settings;
}

async function updateUserSettings(username, newSettings) {
    var current = await readUserSettings(username);
    for (var key in newSettings) {
        current[key] = newSettings[key];
    }
    var lines = [];
    for (var k in current) {
        lines.push(k + '=' + current[k]);
    }
    var newContent = lines.join('\n');
    
    var filePath = 'user_data/' + username + '/set.txt';
    var encodedPath = filePath.split('/').map(seg => encodeURIComponent(seg)).join('/');
    var url = GITEE_CONFIG.BASE_URL + '/repos/' + GITEE_CONFIG.OWNER + '/' + GITEE_CONFIG.REPO + '/contents/' + encodedPath;
    
    var sha = null;
    try {
        var existing = await giteeRequest(url, { method: 'GET' });
        if (!Array.isArray(existing) && existing && existing.sha) {
            sha = existing.sha;
        }
    } catch (e) {
        if (e.status !== 404) throw e;
    }
    
    var putBody = {
        content: utf8ToB64(newContent),
        message: 'Update theme setting for ' + username
    };
    if (sha) putBody.sha = sha;
    
    await giteeRequest(url, {
        method: 'PUT',
        body: JSON.stringify(putBody)
    });
    console.log('设置已保存:', newSettings); // 调试
}

function applyDarkMode(enable) {
    console.log('应用暗黑模式:', enable); // 调试
    if (enable) {
        document.body.classList.add('dark-mode');
    } else {
        document.body.classList.remove('dark-mode');
    }
}

async function initThemeSettings() {
    var toggle = document.getElementById('dark-mode-toggle');
    var statusEl = document.getElementById('theme-status');
    if (!toggle) {
        console.log('未找到主题开关');
        return;
    }
    
    var settings = await readUserSettings(currentUser.username);
    var darkMode = settings.dark === 'true';
    console.log('初始化暗黑模式:', darkMode);
    toggle.checked = darkMode;
    applyDarkMode(darkMode);
    
    var cooldown = false;
    
    toggle.addEventListener('change', async function(e) {
        console.log('开关变化，冷却中:', cooldown);
        if (cooldown) {
            toggle.checked = !toggle.checked;
            statusEl.style.display = 'block';
            statusEl.innerText = '请等待5秒后再试';
            return;
        }
        
        var newMode = toggle.checked;
        console.log('新模式:', newMode);
        applyDarkMode(newMode);
        
        cooldown = true;
        toggle.disabled = true;
        statusEl.style.display = 'block';
        statusEl.innerText = '切换冷却中 (5秒)';
        
        await updateUserSettings(currentUser.username, { dark: newMode ? 'true' : 'false' });
        
        var countdown = 5;
        var interval = setInterval(() => {
            countdown--;
            if (statusEl) statusEl.innerText = `切换冷却中 (${countdown}秒)`;
        }, 1000);
        
        setTimeout(() => {
            clearInterval(interval);
            cooldown = false;
            toggle.disabled = false;
            if (statusEl) statusEl.style.display = 'none';
        }, 5000);
    });
}

// ==================== 主函数（完全保留原有退出逻辑）====================
function initSetting() {
    showBottomBar();
    console.log('个人页已初始化');
    
    // 获取当前用户（原有逻辑）
    if (!currentUser) {
        var cached = localStorage.getItem('currentUser');
        if (cached) {
            try { currentUser = JSON.parse(cached); } catch (e) { localStorage.removeItem('currentUser'); }
        }
    }
    if (!currentUser) {
        // 原有跳转方式
        if (typeof loadPageByUrl === 'function') {
            loadPageByUrl('main/sign.html');
        } else {
            window.location.href = 'main/sign.html';
        }
        return;
    }
    
    // 加载用户信息
    loadUserInfo();
    
    // 初始化主题设置（新增）
    initThemeSettings();
    
    // 绑定折叠事件（原有）
    var profileHeader = document.getElementById('profile-header');
    if (profileHeader) {
        profileHeader.addEventListener('click', function() {
            toggleCollapse('profile-content', 'profile-collapse-icon');
        });
    }
    
    var themeHeader = document.getElementById('theme-header');
    if (themeHeader) {
        themeHeader.addEventListener('click', function() {
            toggleCollapse('theme-content', 'theme-collapse-icon');
        });
    }
    
    var postExpandIcon = document.getElementById('post-expand-icon');
    if (postExpandIcon) {
        postExpandIcon.addEventListener('click', function(e) {
            e.stopPropagation();
            togglePostList();
        });
    }
    
    // 退出登录（完全保持原有方式，未作任何改动）
    var logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.onclick = function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            if (typeof loadPageByUrl === 'function') {
                loadPageByUrl('main/sign.html');
            } else {
                window.location.href = 'main/sign.html';
            }
        };
    }
}