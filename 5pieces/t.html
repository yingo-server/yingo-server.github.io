<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ›å»ºæˆ¿é—´æµ‹è¯• Â· äº”å­æ£‹</title>
    <style>
        * { box-sizing: border-box; font-family: system-ui, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f5f5f5; padding: 20px; display: flex; justify-content: center; }
        .test-container { max-width: 1000px; width: 100%; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); padding: 24px; }
        h1 { font-size: 1.8rem; color: #f4b740; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 12px; display: flex; align-items: center; gap: 8px; }
        h2 { font-size: 1.3rem; margin: 20px 0 10px; color: #333; }
        .config-panel { background: #fef7e9; border-radius: 8px; padding: 16px; margin: 16px 0; border: 1px solid #f4b740; }
        .config-item { font-family: monospace; background: rgba(255,255,255,0.6); padding: 4px 8px; border-radius: 4px; margin-bottom: 4px; }
        .input-group { display: flex; gap: 10px; margin: 20px 0; flex-wrap: wrap; align-items: center; }
        .input-group label { font-weight: 500; min-width: 60px; }
        .input-group input { flex: 1; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; min-width: 200px; }
        .input-group input:focus { outline: 2px solid #f4b740; border-color: transparent; }
        .button-group { display: flex; gap: 12px; flex-wrap: wrap; margin: 20px 0; }
        button { background: #f4b740; border: none; color: #2c1e0e; padding: 10px 20px; border-radius: 30px; font-size: 1rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-bottom: 3px solid #d89c2c; transition: 0.1s; }
        button:hover { background: #d89c2c; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        button:active { transform: translateY(2px); border-bottom-width: 1px; }
        .log-area { background: #1e1e1e; color: #d4d4d4; font-family: 'Fira Code', monospace; font-size: 0.8rem; padding: 16px; border-radius: 8px; height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; border: 1px solid #444; margin-top: 20px; }
        .log-entry { margin-bottom: 4px; border-left: 3px solid #f4b740; padding-left: 8px; }
        .log-time { color: #9cdcfe; margin-right: 8px; }
        .log-level { display: inline-block; padding: 0 4px; border-radius: 3px; font-weight: bold; margin-right: 8px; }
        .level-info { background: #007acc; color: white; }
        .level-success { background: #388e3c; color: white; }
        .level-warning { background: #f57c00; color: white; }
        .level-error { background: #d32f2f; color: white; }
        .note { background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 4px solid #4caf50; margin: 15px 0; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ—ï¸ åˆ›å»ºæˆ¿é—´ä¸“é¡¹æµ‹è¯•</h1>
        
        <!-- é…ç½®æ˜¾ç¤º -->
        <div class="config-panel" id="configPanel">
            <h3>å½“å‰ Gitee é…ç½® (ä» config.js åŠ è½½)</h3>
            <div id="configDisplay">åŠ è½½ä¸­...</div>
        </div>

        <!-- è¾“å…¥åŒº -->
        <div class="input-group">
            <label>æˆ¿é—´åï¼š</label>
            <input type="text" id="roomName" placeholder="ä¾‹å¦‚ æˆ‘çš„æˆ¿é—´" value="æµ‹è¯•æˆ¿é—´">
        </div>
        <div class="input-group">
            <label>ç©å®¶åï¼š</label>
            <input type="text" id="playerName" placeholder="ä½ çš„åå­—" value="æµ‹è¯•ç©å®¶">
        </div>

        <div class="button-group">
            <button id="createRoomBtn"><span>â•</span> æ‰§è¡Œå®Œæ•´åˆ›å»ºæˆ¿é—´æµç¨‹</button>
            <button id="checkListBtn"><span>ğŸ“‹</span> æ£€æŸ¥ rooms/list.txt</button>
            <button id="clearLogBtn"><span>ğŸ—‘ï¸</span> æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="note">
            <strong>ğŸ“Œ æµ‹è¯•è¯´æ˜ï¼š</strong><br>
            - ç‚¹å‡»â€œæ‰§è¡Œå®Œæ•´åˆ›å»ºæˆ¿é—´æµç¨‹â€å°†æ¨¡æ‹Ÿç¨‹åºä¸­çš„åˆ›å»ºæˆ¿é—´æ­¥éª¤ï¼š<br>
            &nbsp;&nbsp;1. æ£€æŸ¥ rooms/list.txtï¼ˆè·å–ç°æœ‰æˆ¿é—´åˆ—è¡¨ï¼‰<br>
            &nbsp;&nbsp;2. ç”Ÿæˆå”¯ä¸€æˆ¿é—´åï¼ˆå¦‚æœé‡å¤åˆ™æ·»åŠ æ—¥æœŸåç¼€ï¼‰<br>
            &nbsp;&nbsp;3. ç”Ÿæˆéšæœº5ä½æ•°æˆ¿é—´å·ï¼Œç¡®ä¿ä¸é‡å¤<br>
            &nbsp;&nbsp;4. åˆ›å»º rooms/æˆ¿é—´å·/vs.txtï¼ˆå†…å®¹ä¸º blackis=ç©å®¶å!white=ï¼‰<br>
            &nbsp;&nbsp;5. æ›´æ–° rooms/list.txtï¼Œè¿½åŠ â€œæˆ¿é—´å!æˆ¿é—´å·â€<br>
            &nbsp;&nbsp;6. ç«‹å³å°è¯•è·å–åˆšåˆ›å»ºçš„æˆ¿é—´ä¿¡æ¯ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼Œæ¯æ¬¡é—´éš”500msï¼‰<br>
            - æ¯ä¸ªæ­¥éª¤çš„ API è¯·æ±‚å’Œå“åº”éƒ½ä¼šè¯¦ç»†è®°å½•åœ¨ä¸‹æ–¹æ—¥å¿—ä¸­ã€‚<br>
            - å¦‚æœæœ€åè·å–çš„æˆ¿é—´ä¿¡æ¯ä¸­ black ä¸æ˜¯ä½ çš„ç©å®¶åï¼Œè¯´æ˜å‡ºç°äº†â€œnot playerâ€é”™è¯¯ã€‚
        </div>

        <!-- æ—¥å¿—åŒº -->
        <div class="log-area" id="logArea">
            <div class="log-entry"><span class="log-time">[ç³»ç»Ÿ]</span> æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•ã€‚</div>
        </div>
    </div>

    <!-- åŠ è½½å…¨å±€é…ç½® -->
    <script src="../js/config.js"></script>

    <!-- å†…è”æµ‹è¯•è„šæœ¬ -->
    <script>
        (function() {
            // ---------- DOM å…ƒç´  ----------
            const roomNameInput = document.getElementById('roomName');
            const playerNameInput = document.getElementById('playerName');
            const logArea = document.getElementById('logArea');
            const configDisplay = document.getElementById('configDisplay');

            // ---------- å·¥å…·å‡½æ•° ----------
            function formatTime() {
                const d = new Date();
                return `[${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}.${d.getMilliseconds().toString().padStart(3,'0')}]`;
            }

            function addLog(message, level = 'info', data = null) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                const timeSpan = document.createElement('span');
                timeSpan.className = 'log-time';
                timeSpan.textContent = formatTime();
                entry.appendChild(timeSpan);

                const levelSpan = document.createElement('span');
                levelSpan.className = `log-level level-${level}`;
                levelSpan.textContent = level.toUpperCase();
                entry.appendChild(levelSpan);

                const textSpan = document.createElement('span');
                textSpan.textContent = message;
                entry.appendChild(textSpan);

                if (data !== null) {
                    const pre = document.createElement('div');
                    pre.style.marginLeft = '20px';
                    pre.style.fontSize = '0.8rem';
                    pre.style.color = '#b5cea8';
                    pre.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                    entry.appendChild(pre);
                }

                logArea.appendChild(entry);
                logArea.scrollTop = logArea.scrollHeight;
            }

            function clearLog() {
                logArea.innerHTML = '';
                addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
            }

            // æ›´æ–°é…ç½®æ˜¾ç¤º
            function updateConfigDisplay() {
                const config = window.GITEE_CONFIG;
                if (!config) {
                    configDisplay.innerHTML = '<span style="color:red;">âŒ é…ç½®æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ js/config.js è·¯å¾„æˆ–å†…å®¹</span>';
                    return;
                }
                let tokenDisplay = config.token;
                if (tokenDisplay && tokenDisplay.length > 8) {
                    tokenDisplay = tokenDisplay.substring(0, 4) + '...' + tokenDisplay.substring(tokenDisplay.length-4);
                }
                const html = `
                    <div class="config-item">owner: ${config.owner || ''}</div>
                    <div class="config-item">repo: ${config.repo || ''}</div>
                    <div class="config-item">branch: ${config.branch || ''}</div>
                    <div class="config-item">token: ${tokenDisplay || ''}</div>
                `;
                configDisplay.innerHTML = html;
            }

            // ---------- Gitee API ç›´æ¥è°ƒç”¨ ----------
            const BASE_URL = 'https://gitee.com/api/v5';

            async function giteeRequest(method, path, bodyData = null, sha = null) {
                const config = window.GITEE_CONFIG;
                if (!config) throw new Error('é…ç½®ä¸å­˜åœ¨');

                let url = `${BASE_URL}/repos/${config.owner}/${config.repo}/contents/${path}?access_token=${config.token}`;
                if (method === 'GET') {
                    url += `&ref=${config.branch}`;
                }

                const fetchOptions = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                };

                if (method !== 'GET') {
                    // å¯¹äº POST/PUTï¼Œéœ€è¦å¤„ç† body
                    fetchOptions.body = JSON.stringify(bodyData);
                }

                addLog(`ğŸŒ ${method} ${path}`, 'debug', { url: url.replace(config.token, '***'), body: bodyData ? { ...bodyData, content: '(base64)' } : undefined });

                const start = Date.now();
                const res = await fetch(url, fetchOptions);
                const elapsed = Date.now() - start;

                let responseData = null;
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await res.json();
                } else {
                    responseData = await res.text();
                }

                addLog(`ğŸ“¥ å“åº” ${res.status} (${elapsed}ms)`, res.ok ? 'success' : 'warning', responseData);

                if (!res.ok) {
                    const err = new Error(`HTTP ${res.status}`);
                    err.status = res.status;
                    err.data = responseData;
                    throw err;
                }

                return responseData;
            }

            // è·å–æ–‡ä»¶ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶è¿”å›å¯¹è±¡ï¼Œå¦‚æœæ˜¯ç›®å½•æˆ–404è¿”å›nullï¼‰
            async function getFile(path) {
                try {
                    const data = await giteeRequest('GET', path);
                    if (Array.isArray(data)) {
                        addLog(`â„¹ï¸ ${path} æ˜¯ä¸€ä¸ªç›®å½•`, 'info', data.map(item => item.name));
                        return null; // æ˜¯ç›®å½•ï¼Œå½“ä½œä¸å­˜åœ¨å¤„ç†
                    }
                    return data; // æ–‡ä»¶å¯¹è±¡
                } catch (e) {
                    if (e.status === 404) return null;
                    throw e;
                }
            }

            // åˆ›å»ºæ–‡ä»¶ï¼ˆPOSTï¼‰
            async function createFile(path, content, message) {
                const base64Content = utf8ToBase64(content);
                const body = {
                    access_token: window.GITEE_CONFIG.token,
                    content: base64Content,
                    message: message,
                    branch: window.GITEE_CONFIG.branch
                };
                return await giteeRequest('POST', path, body);
            }

            // æ›´æ–°æ–‡ä»¶ï¼ˆPUTï¼‰
            async function updateFile(path, content, sha, message) {
                const base64Content = utf8ToBase64(content);
                const body = {
                    access_token: window.GITEE_CONFIG.token,
                    content: base64Content,
                    sha: sha,
                    message: message,
                    branch: window.GITEE_CONFIG.branch
                };
                return await giteeRequest('PUT', path, body);
            }

            // UTF8 è½¬ Base64
            function utf8ToBase64(str) {
                const encoder = new TextEncoder();
                const utf8Bytes = encoder.encode(str);
                let binaryString = '';
                utf8Bytes.forEach(byte => binaryString += String.fromCharCode(byte));
                return btoa(binaryString);
            }

            // ç”Ÿæˆéšæœº5ä½æ•°
            function randomId() {
                return Math.floor(10000 + Math.random() * 90000).toString();
            }

            // è§£æ vs.txt å†…å®¹
            function parseVsContent(content) {
                const lines = content.trim().split('\n');
                const header = lines[0];
                const match = header.match(/blackis=([^!]*)!white=(.*)/);
                if (!match) return null;
                const [, black, white] = match;
                const moves = [];
                let gameOver = false;
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === 'gg') { gameOver = true; break; }
                    if (line) moves.push(line);
                }
                return { black, white, moves, gameOver };
            }

            // è·å–æˆ¿é—´ä¿¡æ¯
            async function getRoomInfo(roomId) {
                const data = await getFile(`rooms/${roomId}/vs.txt`);
                if (!data) return null;
                const content = atob(data.content);
                return parseVsContent(content);
            }

            // æ£€æŸ¥ rooms/list.txt å¹¶è¿”å›æˆ¿é—´åˆ—è¡¨
            async function getRoomList() {
                const data = await getFile('rooms/list.txt');
                if (!data) return [];
                const content = atob(data.content);
                return content.trim().split('\n').filter(line => line).map(line => {
                    const [name, id] = line.split('!');
                    return { name, id };
                });
            }

            // ç”Ÿæˆå”¯ä¸€æˆ¿é—´åï¼ˆä¸ä¸»ç¨‹åºé€»è¾‘ä¸€è‡´ï¼‰
            async function generateUniqueRoomName(baseName) {
                if (!baseName) return baseName;
                const roomList = await getRoomList();
                const existingNames = roomList.map(r => r.name);
                let uniqueName = baseName;
                let counter = 1;
                while (existingNames.includes(uniqueName)) {
                    const now = new Date();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    uniqueName = `${baseName}-${month}-${day}`;
                    if (existingNames.includes(uniqueName)) {
                        uniqueName = `${baseName}-${month}-${day}-${counter}`;
                        counter++;
                    }
                }
                return uniqueName;
            }

            // ---------- æ ¸å¿ƒæµ‹è¯•ï¼šåˆ›å»ºæˆ¿é—´æµç¨‹ ----------
            async function testCreateRoom() {
                const roomName = roomNameInput.value.trim();
                const playerName = playerNameInput.value.trim();
                if (!roomName || !playerName) {
                    addLog('âŒ è¯·å¡«å†™æˆ¿é—´åå’Œç©å®¶å', 'error');
                    return;
                }

                addLog('========== å¼€å§‹åˆ›å»ºæˆ¿é—´æµ‹è¯• ==========', 'info');

                try {
                    // 1. æ£€æŸ¥ rooms/list.txt
                    addLog('--- æ­¥éª¤1: æ£€æŸ¥ rooms/list.txt ---', 'info');
                    const listData = await getFile('rooms/list.txt');
                    let listContent = '';
                    let listSha = null;
                    if (listData) {
                        listContent = atob(listData.content);
                        listSha = listData.sha;
                        addLog('âœ… rooms/list.txt å·²å­˜åœ¨ï¼Œå†…å®¹å¦‚ä¸‹', 'info', listContent);
                    } else {
                        addLog('â„¹ï¸ rooms/list.txt ä¸å­˜åœ¨ï¼Œå°†åœ¨åç»­åˆ›å»º', 'info');
                    }

                    // 2. è·å–ç°æœ‰æˆ¿é—´åˆ—è¡¨ï¼Œé¿å…æˆ¿é—´å·é‡å¤
                    addLog('--- æ­¥éª¤2: è§£æç°æœ‰æˆ¿é—´åˆ—è¡¨ ---', 'info');
                    const existingRooms = await getRoomList();
                    const existingIds = new Set(existingRooms.map(r => r.id));
                    addLog(`ç°æœ‰æˆ¿é—´æ•°: ${existingRooms.length}`, 'info', existingRooms);

                    // 3. ç”Ÿæˆå”¯ä¸€æˆ¿é—´å
                    addLog('--- æ­¥éª¤3: ç”Ÿæˆå”¯ä¸€æˆ¿é—´å ---', 'info');
                    const uniqueRoomName = await generateUniqueRoomName(roomName);
                    if (uniqueRoomName !== roomName) {
                        addLog(`æˆ¿é—´åå·²å­˜åœ¨ï¼Œè‡ªåŠ¨ä¿®æ”¹ä¸º: ${uniqueRoomName}`, 'warning');
                    } else {
                        addLog(`æˆ¿é—´åå¯ç”¨: ${uniqueRoomName}`, 'success');
                    }

                    // 4. ç”Ÿæˆå”¯ä¸€æˆ¿é—´å·
                    addLog('--- æ­¥éª¤4: ç”Ÿæˆå”¯ä¸€æˆ¿é—´å· ---', 'info');
                    let roomId;
                    do {
                        roomId = randomId();
                    } while (existingIds.has(roomId));
                    addLog(`ç”Ÿæˆæˆ¿é—´å·: ${roomId}`, 'success');

                    // 5. åˆ›å»º vs.txt
                    addLog('--- æ­¥éª¤5: åˆ›å»º rooms/${roomId}/vs.txt ---', 'info');
                    const vsPath = `rooms/${roomId}/vs.txt`;
                    const vsContent = `blackis=${playerName}!white=\n`;
                    await createFile(vsPath, vsContent, `åˆ›å»ºæˆ¿é—´ ${uniqueRoomName}`);
                    addLog(`âœ… vs.txt åˆ›å»ºæˆåŠŸ`, 'success');

                    // 6. æ›´æ–° rooms/list.txt
                    addLog('--- æ­¥éª¤6: æ›´æ–° rooms/list.txt ---', 'info');
                    const listEntry = `${uniqueRoomName}!${roomId}`;
                    let newListContent;
                    if (listData) {
                        newListContent = listContent + listEntry + '\n';
                        await updateFile('rooms/list.txt', newListContent, listSha, 'æ·»åŠ æˆ¿é—´');
                    } else {
                        newListContent = listEntry + '\n';
                        await createFile('rooms/list.txt', newListContent, 'åˆ›å»ºæˆ¿é—´åˆ—è¡¨');
                    }
                    addLog(`âœ… list.txt æ›´æ–°æˆåŠŸ`, 'success', listEntry);

                    // 7. ç«‹å³è·å–åˆšåˆ›å»ºçš„æˆ¿é—´ä¿¡æ¯ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
                    addLog('--- æ­¥éª¤7: éªŒè¯æˆ¿é—´ä¿¡æ¯ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰---', 'info');
                    let roomInfo = null;
                    for (let i = 1; i <= 3; i++) {
                        addLog(`å°è¯• #${i} ...`, 'info');
                        try {
                            roomInfo = await getRoomInfo(roomId);
                            if (roomInfo) {
                                addLog(`è·å–åˆ°æˆ¿é—´ä¿¡æ¯`, 'success', roomInfo);
                                break;
                            } else {
                                addLog(`æˆ¿é—´ä¿¡æ¯ä¸ºç©º`, 'warning');
                            }
                        } catch (e) {
                            addLog(`è·å–å¼‚å¸¸: ${e.message}`, 'error');
                        }
                        if (i < 3) {
                            addLog(`ç­‰å¾… 500ms åé‡è¯•...`, 'debug');
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }

                    // 8. æ£€æŸ¥ç©å®¶æ˜¯å¦åœ¨é»‘æ–¹
                    if (roomInfo) {
                        if (roomInfo.black === playerName) {
                            addLog(`âœ… éªŒè¯æˆåŠŸï¼šç©å®¶ "${playerName}" æ˜¯é»‘æ–¹`, 'success');
                        } else {
                            addLog(`âŒ éªŒè¯å¤±è´¥ï¼šç©å®¶ "${playerName}" ä¸æ˜¯é»‘æ–¹ï¼Œå½“å‰ black=${roomInfo.black}`, 'error');
                        }
                        if (roomInfo.white === '') {
                            addLog(`âœ… ç™½æ–¹ä¸ºç©ºï¼Œç¬¦åˆé¢„æœŸ`, 'success');
                        } else {
                            addLog(`âš ï¸ ç™½æ–¹ä¸ä¸ºç©ºï¼š${roomInfo.white}`, 'warning');
                        }
                    } else {
                        addLog(`âŒ æ— æ³•è·å–æˆ¿é—´ä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥`, 'error');
                    }

                    addLog('========== æµ‹è¯•å®Œæˆ ==========', 'info');
                } catch (e) {
                    addLog(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${e.message}`, 'error', e.data || e);
                }
            }

            // å•ç‹¬æ£€æŸ¥ rooms/list.txt
            async function checkListFile() {
                addLog('========== æ£€æŸ¥ rooms/list.txt ==========', 'info');
                try {
                    const data = await getFile('rooms/list.txt');
                    if (!data) {
                        addLog('âŒ rooms/list.txt ä¸å­˜åœ¨', 'warning');
                        return;
                    }
                    const content = atob(data.content);
                    addLog('âœ… rooms/list.txt å†…å®¹', 'success', content);
                    const lines = content.trim().split('\n').filter(l => l);
                    addLog(`å…±æœ‰ ${lines.length} ä¸ªæˆ¿é—´`, 'info', lines);
                } catch (e) {
                    addLog(`âŒ æ£€æŸ¥å¤±è´¥: ${e.message}`, 'error');
                }
            }

            // ---------- äº‹ä»¶ç»‘å®š ----------
            document.getElementById('createRoomBtn').addEventListener('click', testCreateRoom);
            document.getElementById('checkListBtn').addEventListener('click', checkListFile);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);

            // åˆå§‹åŒ–é…ç½®æ˜¾ç¤º
            updateConfigDisplay();
            setTimeout(updateConfigDisplay, 100);
        })();
    </script>
</body>
</html>