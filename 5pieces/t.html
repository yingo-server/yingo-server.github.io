<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>AI å†³ç­–è°ƒè¯• Â· äº”å­æ£‹</title>
    <style>
        * { box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        body { background: #f5f5f5; padding: 20px; display: flex; justify-content: center; margin: 0; }
        .test-container { max-width: 1400px; width: 100%; background: white; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); padding: 24px; }
        h1 { font-size: 1.8rem; color: #f4b740; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 12px; }
        h2 { font-size: 1.3rem; margin: 20px 0 10px; color: #333; }
        .board-container { display: flex; gap: 24px; flex-wrap: wrap; }
        .board-wrapper { flex: 1; min-width: 300px; max-width: 500px; }
        canvas { width: 100%; height: auto; aspect-ratio: 1/1; background: #ecd5b0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: block; }
        .control-panel { flex: 1; min-width: 300px; }
        .button-group { display: flex; gap: 12px; margin: 16px 0; flex-wrap: wrap; }
        button { background: #f4b740; border: none; color: #2c1e0e; padding: 10px 20px; border-radius: 30px; font-size: 1rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border-bottom: 3px solid #d89c2c; transition: 0.1s; }
        button:hover { background: #d89c2c; transform: translateY(-2px); }
        button:active { transform: translateY(2px); border-bottom-width: 1px; }
        .log-area { background: #1e1e1e; color: #d4d4d4; font-family: 'Fira Code', monospace; font-size: 0.8rem; padding: 16px; border-radius: 8px; height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word; border: 1px solid #444; margin-top: 20px; }
        .log-entry { margin-bottom: 4px; border-left: 3px solid #f4b740; padding-left: 8px; }
        .log-time { color: #9cdcfe; margin-right: 8px; }
        .log-level { display: inline-block; padding: 0 4px; border-radius: 3px; font-weight: bold; margin-right: 8px; }
        .level-info { background: #007acc; color: white; }
        .level-success { background: #388e3c; color: white; }
        .level-warning { background: #f57c00; color: white; }
        .level-error { background: #d32f2f; color: white; }
        .level-debug { background: #6b4f32; color: white; }
        table { border-collapse: collapse; width: 100%; font-size: 0.8rem; background: white; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background: #f4b740; color: #2c1e0e; position: sticky; top: 0; }
        .candidates-table-wrapper { max-height: 300px; overflow-y: auto; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ AI å†³ç­–è°ƒè¯•å·¥å…·</h1>
        <div class="board-container">
            <div class="board-wrapper">
                <canvas id="board" width="500" height="500"></canvas>
            </div>
            <div class="control-panel">
                <h2>æ‰‹åŠ¨è®¾ç½®æ£‹ç›˜</h2>
                <div class="button-group">
                    <button id="setBlackBtn">âš« è®¾ä¸ºé»‘å­</button>
                    <button id="setWhiteBtn">âšª è®¾ä¸ºç™½å­</button>
                    <button id="clearBoardBtn">ğŸ—‘ï¸ æ¸…ç©ºæ£‹ç›˜</button>
                </div>
                <div class="button-group">
                    <button id="runAIBtn">ğŸ¤– è¿è¡ŒAIå†³ç­– (AIä¸ºç™½æ–¹)</button>
                    <button id="runAIBtnBlack">ğŸ¤– è¿è¡ŒAIå†³ç­– (AIä¸ºé»‘æ–¹)</button>
                    <button id="clearLogBtn">ğŸ“‹ æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div class="button-group">
                    <button id="presetLiveFourBtn">ğŸ”´ é¢„è®¾æ´»å››å±€é¢ (ç™½æ–¹æ´»å››)</button>
                    <button id="presetLiveThreeBtn">ğŸŸ¡ é¢„è®¾æ´»ä¸‰å±€é¢ (ç™½æ–¹æ´»ä¸‰)</button>
                </div>
                <p>ç‚¹å‡»æ£‹ç›˜æ ¼å­å¯è®¾ç½®æ£‹å­ï¼ˆå½“å‰é¢œè‰²: <span id="currentColor">âš« é»‘å­</span>)</p>
                <p>AIå†³ç­–æ—¥å¿—å°†æ˜¾ç¤ºæ¯ä¸ªå€™é€‰ç‚¹çš„è¯¦ç»†è¯„åˆ†</p>
            </div>
        </div>

        <h2>ğŸ“Š å€™é€‰ç‚¹è¯„åˆ†</h2>
        <div class="candidates-table-wrapper" id="candidatesTable"></div>

        <h2>ğŸ“œ è¯¦ç»†æ—¥å¿—</h2>
        <div class="log-area" id="logArea"></div>
    </div>

    <script type="module">
        // ---------- å¸¸é‡å®šä¹‰ï¼ˆé¿å…ä¾èµ–å¤–éƒ¨æ–‡ä»¶ï¼‰----------
        const BOARD_SIZE = 15;
        const CANVAS_SIZE = 500;

        // ---------- å¯¼å…¥AIæ¨¡å— ----------
        import { getThreatLevel, isOneStepKill } from './js/ai/threat.js';
        import { evaluate } from './js/ai/evaluator.js';

        // ---------- å…¨å±€å˜é‡ ----------
        const canvas = document.getElementById('board');
        const ctx = canvas.getContext('2d');
        const logArea = document.getElementById('logArea');
        const candidatesTable = document.getElementById('candidatesTable');
        const currentColorSpan = document.getElementById('currentColor');

        let board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
        let currentPlayer = 1; // 1é»‘ 2ç™½
        const cellSize = CANVAS_SIZE / BOARD_SIZE;
        const pieceRadius = cellSize * 0.4;

        // ---------- æ—¥å¿—å‡½æ•° ----------
        function addLog(message, level = 'info', data = null) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const time = new Date();
            const timeStr = `[${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}:${time.getSeconds().toString().padStart(2,'0')}.${time.getMilliseconds().toString().padStart(3,'0')}]`;
            
            entry.innerHTML = `<span class="log-time">${timeStr}</span><span class="log-level level-${level}">${level.toUpperCase()}</span> ${message}`;
            if (data) {
                const pre = document.createElement('pre');
                pre.style.margin = '4px 0 0 20px';
                pre.style.fontSize = '0.75rem';
                pre.style.color = '#b5cea8';
                pre.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                entry.appendChild(pre);
            }
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            logArea.innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }

        // ---------- ç»˜åˆ¶æ£‹ç›˜ï¼ˆä½¿ç”¨çº¯è‰²ç¡®ä¿æ£‹å­å¯è§ï¼‰----------
        function drawBoard() {
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            ctx.fillStyle = '#ecd5b0';
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            // ç”»ç½‘æ ¼
            ctx.strokeStyle = '#6b4f32';
            ctx.lineWidth = 1.5;
            for (let i = 0; i < BOARD_SIZE; i++) {
                const pos = i * cellSize + cellSize/2;
                ctx.beginPath();
                ctx.moveTo(cellSize/2, pos);
                ctx.lineTo(CANVAS_SIZE - cellSize/2, pos);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos, cellSize/2);
                ctx.lineTo(pos, CANVAS_SIZE - cellSize/2);
                ctx.stroke();
            }

            // ç”»æ˜Ÿä½
            const stars = [[3,3], [11,3], [7,7], [3,11], [11,11]];
            ctx.fillStyle = '#6b4f32';
            stars.forEach(([r, c]) => {
                const x = c * cellSize + cellSize/2;
                const y = r * cellSize + cellSize/2;
                ctx.beginPath();
                ctx.arc(x, y, cellSize*0.1, 0, 2*Math.PI);
                ctx.fill();
            });

            // ç”»æ£‹å­ï¼ˆç®€åŒ–ï¼šçº¯è‰²ï¼Œç¡®ä¿ç™½æ–¹å¯è§ï¼‰
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] === 0) continue;
                    const x = c * cellSize + cellSize/2;
                    const y = r * cellSize + cellSize/2;
                    const isBlack = board[r][c] === 1;
                    
                    ctx.beginPath();
                    ctx.arc(x, y, pieceRadius, 0, 2*Math.PI);
                    ctx.fillStyle = isBlack ? '#222' : '#f0f0f0';
                    ctx.fill();
                    ctx.strokeStyle = '#888';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }
        }

        // ---------- ç”Ÿæˆå€™é€‰ç‚¹ ----------
        function generateCandidates() {
            const candidatesSet = new Set();
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] !== 0) {
                        for (let dr = -2; dr <= 2; dr++) {
                            for (let dc = -2; dc <= 2; dc++) {
                                const nr = r + dr;
                                const nc = c + dc;
                                if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === 0) {
                                    const dist = Math.abs(dr) + Math.abs(dc);
                                    if (dist <= 2) {
                                        candidatesSet.add(nr * BOARD_SIZE + nc);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if (candidatesSet.size === 0) return [[7,7]];
            return Array.from(candidatesSet).map(code => [Math.floor(code / BOARD_SIZE), code % BOARD_SIZE]);
        }

        // ---------- æ˜¾ç¤ºå€™é€‰ç‚¹è¯„åˆ†è¡¨æ ¼ ----------
        async function showCandidatesScores(aiPlayer) {
            const opponent = aiPlayer === 1 ? 2 : 1;
            const candidates = generateCandidates();
            
            let html = '<table><tr><th>è¡Œ</th><th>åˆ—</th><th>è¿›æ”»ä»·å€¼</th><th>é˜²å®ˆä»·å€¼</th><th>ç»¼åˆè¯„åˆ†</th><th>ä¸€æ­¥æ€?</th><th>å¯¹æ‰‹å¨èƒ</th></tr>';
            
            for (let [r, c] of candidates) {
                const attack = isOneStepKill(board, r, c, aiPlayer) ? 1050 : 0;
                const defense = getThreatLevel(board, r, c, opponent);
                const score = Math.max(attack, defense);
                const oppThreat = getThreatLevel(board, r, c, opponent);
                
                html += `<tr>
                    <td>${r}</td>
                    <td>${c}</td>
                    <td>${attack}</td>
                    <td>${defense}</td>
                    <td><strong>${score}</strong></td>
                    <td>${isOneStepKill(board, r, c, aiPlayer) ? 'âœ…' : 'âŒ'}</td>
                    <td>${oppThreat}</td>
                </tr>`;
            }
            html += '</table>';
            candidatesTable.innerHTML = html;
        }

        // ---------- äº‹ä»¶ç›‘å¬ ----------
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scale = CANVAS_SIZE / rect.width; // canvasç‰©ç†åƒç´ ä¸CSSåƒç´ æ¯”ä¾‹
            const x = (e.clientX - rect.left) * scale;
            const y = (e.clientY - rect.top) * scale;
            const col = Math.floor(x / cellSize);
            const row = Math.floor(y / cellSize);
            
            if (row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE) {
                if (board[row][col] === 0) {
                    board[row][col] = currentPlayer;
                    addLog(`åœ¨ (${row},${col}) æ”¾ç½® ${currentPlayer === 1 ? 'é»‘å­' : 'ç™½å­'}`, 'info');
                    drawBoard();
                }
            }
        });

        document.getElementById('setBlackBtn').addEventListener('click', () => {
            currentPlayer = 1;
            currentColorSpan.innerHTML = 'âš« é»‘å­';
        });

        document.getElementById('setWhiteBtn').addEventListener('click', () => {
            currentPlayer = 2;
            currentColorSpan.innerHTML = 'âšª ç™½å­';
        });

        document.getElementById('clearBoardBtn').addEventListener('click', () => {
            board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
            drawBoard();
            addLog('æ£‹ç›˜å·²æ¸…ç©º', 'warning');
            candidatesTable.innerHTML = '';
        });

        document.getElementById('runAIBtn').addEventListener('click', async () => {
            addLog('========== AIå†³ç­–å¼€å§‹ (AIä¸ºç™½æ–¹) ==========', 'info');
            await showCandidatesScores(2);
            const start = Date.now();
            const [row, col] = evaluate(board, 2, 0);
            const elapsed = Date.now() - start;
            addLog(`AIé€‰æ‹©: (${row},${col})ï¼Œè€—æ—¶ ${elapsed}ms`, 'success');
        });

        document.getElementById('runAIBtnBlack').addEventListener('click', async () => {
            addLog('========== AIå†³ç­–å¼€å§‹ (AIä¸ºé»‘æ–¹) ==========', 'info');
            await showCandidatesScores(1);
            const start = Date.now();
            const [row, col] = evaluate(board, 1, 0);
            const elapsed = Date.now() - start;
            addLog(`AIé€‰æ‹©: (${row},${col})ï¼Œè€—æ—¶ ${elapsed}ms`, 'success');
        });

        document.getElementById('presetLiveFourBtn').addEventListener('click', () => {
            board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
            for (let i = 0; i < 4; i++) {
                board[7][7 + i] = 2;
            }
            drawBoard();
            addLog('é¢„è®¾æ´»å››å±€é¢ï¼šç™½æ–¹åœ¨ (7,7)-(7,10) æœ‰è¿ç»­å››å­', 'warning');
        });

        document.getElementById('presetLiveThreeBtn').addEventListener('click', () => {
            board = Array(BOARD_SIZE).fill().map(() => Array(BOARD_SIZE).fill(0));
            for (let i = 0; i < 3; i++) {
                board[7][7 + i] = 2;
            }
            drawBoard();
            addLog('é¢„è®¾æ´»ä¸‰å±€é¢ï¼šç™½æ–¹åœ¨ (7,7)-(7,9) æœ‰è¿ç»­ä¸‰å­', 'warning');
        });

        document.getElementById('clearLogBtn').addEventListener('click', clearLog);

        // åˆå§‹ç»˜åˆ¶
        drawBoard();
        addLog('æµ‹è¯•é¡µé¢å·²åŠ è½½ã€‚ç‚¹å‡»æ£‹ç›˜æ”¾ç½®æ£‹å­ï¼Œè¿è¡ŒAIæŸ¥çœ‹å†³ç­–æ—¥å¿—ã€‚', 'info');
    </script>
</body>
</html>