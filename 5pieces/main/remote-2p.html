<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>远程双人对战 · 五子棋</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="../css/base/reset.css">
    <link rel="stylesheet" href="../css/base/typography.css">
    <link rel="stylesheet" href="../css/theme/material-colors.css">
    <link rel="stylesheet" href="../css/theme/animations.css">
    <link rel="stylesheet" href="../css/layout/container.css">
    <link rel="stylesheet" href="../css/components/buttons.css">
    <link rel="stylesheet" href="../css/components/board.css">
    <link rel="stylesheet" href="../css/components/toast.css">
    <link rel="stylesheet" href="../css/pages/remote-2p.css">
</head>
<body class="md2-theme remote-2p-page">
    <div class="container">
        <header class="page-header">
            <a href="../index.html" class="md2-icon-button">
                <span class="material-icons">arrow_back</span>
            </a>
            <h2 class="md2-title">远程双人对战</h2>
            <div style="width: 40px;"></div>
        </header>

        <!-- 初始界面：创建/加入房间 -->
        <div id="lobby" class="lobby-section">
            <div class="md2-card">
                <h3 class="md2-headline6">创建房间</h3>
                <div class="input-field">
                    <span class="material-icons">badge</span>
                    <input type="text" id="createRoomName" placeholder="房间名称" class="md2-input">
                </div>
                <div class="input-field">
                    <span class="material-icons">person</span>
                    <input type="text" id="createPlayerName" placeholder="你的名字" class="md2-input">
                </div>
                <button class="md2-button" id="createBtn">创建房间</button>
            </div>

            <div class="md2-card">
                <h3 class="md2-headline6">加入房间</h3>
                <div class="input-field">
                    <span class="material-icons">meeting_room</span>
                    <input type="text" id="joinRoomId" placeholder="房间号" class="md2-input">
                </div>
                <div class="input-field">
                    <span class="material-icons">person</span>
                    <input type="text" id="joinPlayerName" placeholder="你的名字" class="md2-input">
                </div>
                <button class="md2-button" id="joinBtn">加入房间</button>
            </div>
        </div>

        <!-- 对战界面（初始隐藏） -->
        <div id="gameArea" class="game-area" style="display: none;">
            <main class="game-main">
                <div class="board-wrapper">
                    <canvas id="board" width="600" height="600" class="board-canvas"></canvas>
                </div>
                <!-- 房间号显示 -->
                <div class="room-id-badge" id="roomIdDisplay">
                    <span class="material-icons">meeting_room</span>
                    <span id="roomIdText"></span>
                </div>
                <div class="turn-indicator" id="turnIndicator">
                    <span class="material-icons">circle</span> 等待
                </div>
                <div class="status-message" id="statusMessage"></div>
                <button class="md2-button" id="leaveBtn">离开房间</button>
            </main>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div id="toast-container" class="md2-toast-container"></div>

    <!-- 先加载全局配置 -->
    <script src="../js/config.js"></script>
    <!-- 然后加载模块化的脚本 -->
    <script type="module">
        import { createRoom, joinRoom, getRoomInfo, getRoomList } from '../js/network/room-manager.js';
        import RemoteGame from '../js/core/remote-game.js';
        import { showToast, showError } from '../js/ui/toast.js';

        const lobbyDiv = document.getElementById('lobby');
        const gameAreaDiv = document.getElementById('gameArea');
        const canvas = document.getElementById('board');
        const turnIndicator = document.getElementById('turnIndicator');
        const statusMessage = document.getElementById('statusMessage');
        const leaveBtn = document.getElementById('leaveBtn');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const roomIdText = document.getElementById('roomIdText');

        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const createRoomName = document.getElementById('createRoomName');
        const createPlayerName = document.getElementById('createPlayerName');
        const joinRoomId = document.getElementById('joinRoomId');
        const joinPlayerName = document.getElementById('joinPlayerName');

        let currentGame = null;

        // 等待房间信息更新（最多重试5次，间隔300ms）
        async function waitForRoomUpdate(roomId, expectedPlayerName, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                const info = await getRoomInfo(roomId);
                if (info) {
                    // 检查玩家是否已成为黑方或白方
                    if (info.black === expectedPlayerName || info.white === expectedPlayerName) {
                        return info;
                    }
                }
                // 等待300ms后重试
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            throw new Error('等待房间更新超时，请稍后重试');
        }

        // 生成唯一房间名（如果重复，添加 -mm-dd 后缀）
        async function generateUniqueRoomName(baseName) {
            if (!baseName) return baseName;
            try {
                const roomList = await getRoomList();
                const existingNames = roomList.map(r => r.name);
                let uniqueName = baseName;
                let counter = 1;
                while (existingNames.includes(uniqueName)) {
                    const now = new Date();
                    const month = (now.getMonth() + 1).toString().padStart(2, '0');
                    const day = now.getDate().toString().padStart(2, '0');
                    uniqueName = `${baseName}-${month}-${day}`;
                    if (existingNames.includes(uniqueName)) {
                        uniqueName = `${baseName}-${month}-${day}-${counter}`;
                        counter++;
                    }
                }
                return uniqueName;
            } catch (e) {
                showError(e, '检查房间名失败');
                return baseName;
            }
        }

        async function enterGame(roomId, playerName) {
            try {
                // 等待并获取最新房间信息（确保数据已同步）
                const info = await waitForRoomUpdate(roomId, playerName);
                
                // 严格检查玩家身份：必须是黑方或白方之一
                if (info.black !== playerName && info.white !== playerName) {
                    showToast('你不是该房间的玩家（身份不匹配）', 'error');
                    return;
                }

                lobbyDiv.style.display = 'none';
                gameAreaDiv.style.display = 'block';

                // 显示房间号
                roomIdText.textContent = roomId;
                roomIdDisplay.style.display = 'flex';

                currentGame = new RemoteGame(canvas, turnIndicator, statusMessage, roomId, playerName);
            } catch (e) {
                showError(e, '进入房间失败');
            }
        }

        createBtn.addEventListener('click', async () => {
            let roomName = createRoomName.value.trim();
            const playerName = createPlayerName.value.trim();
            if (!roomName || !playerName) {
                showToast('请填写房间名称和你的名字', 'warning');
                return;
            }
            try {
                const uniqueRoomName = await generateUniqueRoomName(roomName);
                if (uniqueRoomName !== roomName) {
                    showToast(`房间名已存在，已自动修改为: ${uniqueRoomName}`, 'info', 3000);
                }
                const roomId = await createRoom(uniqueRoomName, playerName);
                if (roomId) {
                    await enterGame(roomId, playerName);
                } else {
                    showToast('创建房间失败（未知错误）', 'error');
                }
            } catch (e) {
                showError(e, '创建房间失败');
            }
        });

        joinBtn.addEventListener('click', async () => {
            const roomId = joinRoomId.value.trim();
            const playerName = joinPlayerName.value.trim();
            if (!roomId || !playerName) {
                showToast('请填写房间号和你的名字', 'warning');
                return;
            }
            try {
                // 尝试加入房间（作为白方）
                const success = await joinRoom(roomId, playerName);
                if (!success) {
                    showToast('加入失败，可能房间已满或不存在', 'error');
                    return;
                }
                // 等待房间信息更新并进入
                await enterGame(roomId, playerName);
            } catch (e) {
                // 根据错误代码给出更具体的提示
                if (e.code === 'ROOM_FULL') {
                    showToast('房间已满，无法加入', 'error');
                } else if (e.code === 'ROOM_NOT_FOUND') {
                    showToast('房间不存在', 'error');
                } else {
                    showError(e, '加入房间失败');
                }
            }
        });

        leaveBtn.addEventListener('click', () => {
            if (currentGame) {
                currentGame.destroy();
                currentGame = null;
            }
            lobbyDiv.style.display = 'flex';
            gameAreaDiv.style.display = 'none';
        });
    </script>
</body>
</html>